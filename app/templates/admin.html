{% extends "base.html" %}

{% block content %}
<style>
    .tab-nav {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 1.5rem;
    }

    .tab-link {
        padding: 0.8rem 1.5rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        opacity: 0.7;
        font-weight: 600;
        transition: 0.2s;
    }

    .tab-link:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.03);
    }

    .tab-link.active {
        border-bottom-color: var(--accent-color);
        color: var(--accent-color);
        opacity: 1;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    /* Run Modal Steps */
    .run-step {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        opacity: 0.4;
        transition: all 0.3s;
    }

    .run-step.active {
        opacity: 1;
    }

    .run-step.completed {
        opacity: 0.6;
    }

    .run-step.completed .step-icon {
        color: var(--success-color);
        border-color: var(--success-color);
        background: rgba(16, 185, 129, 0.1);
    }

    .step-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: var(--text-secondary);
        flex-shrink: 0;
        background: var(--bg-primary);
    }

    .run-step.active .step-icon {
        border-color: var(--accent-color);
        color: var(--accent-color);
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
    }

    .step-content {
        text-align: left;
    }

    .step-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.1rem;
    }

    .step-desc {
        font-size: 0.75rem;
        opacity: 0.7;
    }
</style>

<div class="page-header">
    <h1 class="page-title">Administration</h1>
</div>

<!-- Clusters Tab -->
<div id="tab-clusters" class="tab-content active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h3 style="margin:0;">Cluster Management</h3>
        {% if user.is_admin %}
        <button class="btn btn-primary" onclick="openModal()">
            <i class="fas fa-plus"></i> Add Cluster
        </button>
        {% endif %}
    </div>

    <div class="card fade-in">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Cluster Name</th>
                        <th>API URL</th>
                        <th>Metadata</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cluster in clusters %}
                    <tr>
                        <td>{{ cluster.name }}</td>
                        <td>{{ cluster.api_url }}</td>
                        <td>
                            <span class="badge badge-blue">{{ cluster.datacenter }}</span>
                            <span class="badge badge-green">{{ cluster.environment }}</span>
                            <!-- Display Tags -->
                            {% if cluster.tags %}
                            {% set tags = cluster.tags | fromjson %}
                            {% for k,v in tags.items() %}
                            <span class="badge"
                                style="background:var(--bg-secondary); border:1px solid var(--border-color); font-size:0.7em;">{{
                                k }}={{ v }}</span>
                            {% endfor %}
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_admin %}
                            <button class="btn btn-secondary" onclick="editCluster({{ cluster.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteCluster({{ cluster.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Schedulers Tab -->
<div id="tab-schedulers" class="tab-content">
    <div class="card fade-in">
        <div style="padding:1rem; border-bottom:1px solid var(--border-color);">
            <h4 style="color:var(--accent-color); margin:0;"><i class="fas fa-clock"></i> Snapshot Scheduler</h4>
        </div>
        <div style="padding:1.5rem;">

            <div
                style="margin-bottom:2rem; padding:1.5rem; background:rgba(56, 189, 248, 0.05); border-left:4px solid var(--accent-color); border-radius:4px;">
                <h5 style="margin-top:0; color:var(--text-primary); font-size:1.1rem; margin-bottom:0.5rem;">About
                    Background Snapshots</h5>
                <p style="font-size:0.95rem; color:var(--text-secondary); margin-bottom:1rem; line-height:1.6;">
                    The <strong>Snapshot Scheduler</strong> automatically connects to all configured clusters to fetch
                    their latest inventory data (nodes, usage metrics, license status).
                </p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-bottom:1rem;">
                    <div>
                        <strong style="color:var(--text-primary);"><i class="fas fa-history"></i> Time Travel</strong>
                        <p style="font-size:0.85rem; color:var(--text-secondary); margin-top:0.2rem;">
                            Snapshots allow you to look back in time. Select a date from the sidebar to view the exact
                            state of your infrastructure at that moment.
                        </p>
                    </div>
                    <div>
                        <strong style="color:var(--text-primary);"><i class="fas fa-archive"></i> Data
                            Retention</strong>
                        <p style="font-size:0.85rem; color:var(--text-secondary); margin-top:0.2rem;">
                            Historical data is distinct from live data. It is stored as a compressed record, ensuring
                            performance is not impacted by history size.
                        </p>
                    </div>
                </div>
                <div
                    style="font-size:0.85rem; opacity:0.8; padding-top:1rem; border-top:1px solid var(--border-color);">
                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> Set the interval below to control how
                    frequently these automatic snapshots are taken. Lower intervals provide more granularity but
                    increase database storage usage.
                </div>
            </div>

            <div class="form-group" style="max-width:500px;">
                <label class="form-label">Polling Configuration</label>
                <div
                    style="background:var(--bg-secondary); padding:1rem; border-radius:8px; border:1px solid var(--border-color);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                        <span style="font-size:0.9rem;">Interval (Minutes)</span>
                        <input type="number" id="poll-interval" class="form-input" min="5" max="1440"
                            value="{{ poll_interval }}" style="width:80px; text-align:center;">
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                        <span style="font-size:0.9rem;">Retention Policy (Days)</span>
                        <input type="number" id="snapshot-retention" class="form-input" min="1" max="365"
                            value="{{ retention_days }}" style="width:80px; text-align:center;">
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                        <span style="font-size:0.9rem;">All Clusters Cache TTL (Min)</span>
                        <input type="number" id="dashboard-cache-ttl" class="form-input" min="1" max="1440"
                            value="{{ dashboard_cache_ttl }}" style="width:80px; text-align:center;">
                    </div>

                    <div style="margin: 1rem 0; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                        <label class="form-label" style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                            <input type="checkbox" id="collect-olm" {% if collect_olm %}checked{% endif %}>
                            <span>Collect Operator Data (CSVs/Subscriptions)</span>
                        </label>
                        <div
                            style="font-size:0.8rem; color:var(--text-secondary); margin-left: 1.5rem; margin-bottom: 0.5rem;">
                            Disabling this reduces snapshot size by ~40%.
                        </div>

                        <label class="form-label" style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                            <input type="checkbox" id="run-compliance" {% if run_compliance %}checked{% endif %}>
                            <span>Run Compliance Checks</span>
                        </label>
                        <div style="font-size:0.8rem; color:var(--text-secondary); margin-left: 1.5rem;">
                            Automatically runs all active audit rules during poll.
                        </div>

                        <div style="margin-top:0.8rem;"></div>

                        <label class="form-label" style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                            <input type="checkbox" id="enable-vacuum" {% if enable_db_vacuum %}checked{% endif %}>
                            <span>Enable Weekly Database Optimization</span>
                        </label>
                        <div style="font-size:0.8rem; color:var(--text-secondary); margin-left: 1.5rem;">
                            Auto-optimizes the database every Sunday at 00:00 to free up space.
                        </div>
                    </div>
                    <div style="display:flex; gap:0.5rem; margin-top:1rem;">
                        {% if user.is_admin %}
                        <button class="btn btn-primary" onclick="saveSchedulerConfig()" style="flex:1;">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        <button class="btn btn-secondary" onclick="openRunNowModal()" style="flex:1;">
                            <i class="fas fa-play"></i> Run Now
                        </button>
                        {% else %}
                        <div
                            style="font-size:0.9rem; color:var(--text-secondary); padding:0.5rem; width:100%; text-align:center;">
                            <i class="fas fa-lock"></i> Settings are read-only for Operators.
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:0.5rem; text-align:center;">
                    Scheduler Status: <span style="color:var(--success-color);">Active</span>
                </div>
            </div>

            <!-- Maintenance / Danger Zone -->
            {% if user.is_admin %}
            <div class="form-group" style="max-width:500px; margin-top: 2rem;">
                <label class="form-label" style="color:var(--danger-color);"><i class="fas fa-exclamation-triangle"></i>
                    Maintenance</label>
                <div
                    style="background:rgba(239, 68, 68, 0.05); padding:1rem; border-radius:8px; border:1px solid rgba(239, 68, 68, 0.2);">
                    <p style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:1rem;">
                        Perform a hard restart of the application pod. This will intentionally crash the process,
                        triggering OpenShift to recreate the pod.
                    </p>
                    <button class="btn" onclick="restartPod()"
                        style="width:100%; background:var(--danger-color); color:white; border:none; padding:0.6rem; border-radius:4px; cursor:pointer; font-weight:600;">
                        <i class="fas fa-power-off"></i> Restart Application
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="tab-snapshots" class="tab-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <div style="display:flex; align-items:center; gap:1.5rem;">
            <h3 style="margin:0;">Snapshot History</h3>
            <div id="snapshot-totals"
                style="font-size:0.85rem; color:var(--text-secondary); background:rgba(255,255,255,0.03); padding:0.4rem 0.8rem; border-radius:15px; border:1px solid var(--border-color);">
                <i class="fas fa-database" style="margin-right:0.4rem; opacity:0.5;"></i>
                <span id="total-runs-count">0</span> Runs (<span id="total-snapshots-count">0</span> Snapshots)
            </div>
        </div>
        <div style="display:flex; gap:1rem; align-items:center;">
            <div style="position:relative;">
                <i class="fas fa-search"
                    style="position:absolute; left:0.75rem; top:50%; transform:translateY(-50%); font-size:0.8rem; color:var(--text-secondary);"></i>
                <input type="text" id="snapshot-search" placeholder="Search snapshots..."
                    style="padding:0.4rem 0.75rem 0.4rem 2rem; border-radius:4px; background:var(--bg-primary); border:1px solid var(--border-color); color:var(--text-primary); font-size:0.9rem;"
                    oninput="filterSnapshotsTable(this.value)">
            </div>

            {% if user.is_admin %}
            <button class="btn btn-danger btn-sm" id="bulk-delete-btn" onclick="bulkDeleteSnapshots()"
                style="display:none;">
                <i class="fas fa-trash"></i> Delete Selected (<span id="selected-count">0</span>)
            </button>

            <div
                style="display:flex; align-items:center; gap:0.5rem; background:rgba(239, 68, 68, 0.05); padding:0.3rem 0.6rem; border-radius:4px; border:1px solid rgba(239, 68, 68, 0.2);">
                <span style="font-size:0.8rem; color:var(--text-secondary);">Older than</span>
                <input type="number" id="cleanup-days" value="30" min="1"
                    style="width:50px; padding:0.2rem; border-radius:4px; border:1px solid var(--border-color); background:var(--bg-primary); color:var(--text-primary); font-size:0.85rem; text-align:center;">
                <span style="font-size:0.8rem; color:var(--text-secondary);">days</span>
                <button class="btn btn-danger btn-sm" onclick="massDeleteSnapshots()">
                    <i class="fas fa-trash-sweep"></i> Mass Delete
                </button>
            </div>
            {% endif %}

            <button class="btn btn-secondary" onclick="loadSnapshotsTable()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

    <div class="card fade-in">
        <div class="table-container">
            <table class="data-table" id="snapshots-table">
                <thead>
                    <tr>
                        <th style="width:40px;"><input type="checkbox" id="select-all-snapshots"
                                onclick="toggleSelectAllSnapshots(this)"></th>
                        <th style="width:40px;"></th>
                        <th>Type</th>
                        <th>Timestamp (EST)</th>
                        <th>Status</th>
                        <th>Stats</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="snapshots-table-body">
                    <tr>
                        <td colspan="6" style="text-align:center;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Run Now Modal -->
<div id="run-now-modal" class="modal">
    <div class="modal-content" style="max-width:450px;">
        <div class="modal-header">
            <h3 id="run-modal-title">Trigger Manual Snapshot</h3>
            <button onclick="closeRunModal()" class="close-btn" id="run-modal-close"><i
                    class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="text-align:center; padding:2rem 1rem;">

            <!-- Confimation State -->
            <div id="run-step-confirm">
                <div style="font-size:3rem; color:var(--accent-color); margin-bottom:1rem;">
                    <i class="fas fa-cloud-download-alt"></i>
                </div>
                <p style="font-size:1.1rem; margin-bottom:0.5rem;">Ready to poll all clusters?</p>
                <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:2rem;">
                    This will immediately connect to all clusters to fetch the latest data. This process typically takes
                    30-60 seconds.
                </p>
                <button class="btn btn-primary" onclick="confirmRunNow()"
                    style="width:100%; font-size:1rem; padding:0.8rem;">
                    Include All Clusters & Start
                </button>
            </div>

            <!-- Loading State -->
            <div id="run-step-loading" style="display:none;">
                <div
                    style="font-size:2rem; font-weight:700; color:var(--text-primary); margin-bottom:0.5rem; font-family:monospace;">
                    <span id="run-timer">00:00</span>
                </div>
                <div style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:1.5rem;">Running Snapshot...
                </div>

                <div style="text-align:left; max-width:320px; margin:0 auto;">
                    <!-- Step 1 -->
                    <div class="run-step active" id="step-1">
                        <div class="step-icon"><i class="fas fa-circle-notch fa-spin"></i></div>
                        <div class="step-content">
                            <div class="step-title">Connection & Metadata</div>
                            <div class="step-desc">Connecting to all clusters...</div>
                        </div>
                    </div>
                    <!-- Step 2 -->
                    <div class="run-step" id="step-2">
                        <div class="step-icon"><i class="fas fa-circle"></i></div>
                        <div class="step-content">
                            <div class="step-title">Core Inventory</div>
                            <div class="step-desc">Fetching Nodes, Projects, Machines...</div>
                        </div>
                    </div>
                    <!-- Step 3 -->
                    <div class="run-step" id="step-3">
                        <div class="step-icon"><i class="fas fa-circle"></i></div>
                        <div class="step-content">
                            <div class="step-title">Operator List</div>
                            <div class="step-desc">Collecting CSVs and Subscriptions...</div>
                        </div>
                    </div>
                    <!-- Step 4 -->
                    <div class="run-step" id="step-4">
                        <div class="step-icon"><i class="fas fa-circle"></i></div>
                        <div class="step-content">
                            <div class="step-title">Compliance Audit</div>
                            <div class="step-desc">Evaluating active policy bundles...</div>
                        </div>
                    </div>
                </div>

                <div id="run-progress-container"
                    style="margin-top:1.5rem; text-align:left; background:var(--bg-secondary); padding:0.8rem; border-radius:8px; border:1px solid var(--border-color);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.3rem; font-size:0.8rem;">
                        <span id="run-current-cluster"
                            style="font-weight:600; color:var(--accent-color);">Initializing...</span>
                        <span id="run-cluster-index" style="opacity:0.7;">0/0</span>
                    </div>
                    <div
                        style="width:100%; height:6px; background:var(--bg-primary); border-radius:4px; overflow:hidden;">
                        <div id="run-progress-bar"
                            style="width:0%; height:100%; background:var(--accent-color); transition: width 0.3s ease;">
                        </div>
                    </div>
                    <div
                        style="font-size:0.75rem; color:var(--text-secondary); margin-top:0.4rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        <i class="fas fa-terminal" style="margin-right:0.3rem; opacity:0.5;"></i> <span
                            id="run-current-resource">waiting...</span>
                    </div>
                </div>
            </div>

            <!-- Success State -->
            <div id="run-step-success" style="display:none;">
                <div style="font-size:3rem; color:var(--success-color); margin-bottom:1rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4 style="margin-bottom:0.5rem;">Snapshot Created!</h4>
                <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:2rem;">
                    The background job has completed successfully.
                </p>
                <div style="display:flex; gap:1rem;">
                    <button class="btn btn-secondary" onclick="closeRunModal()" style="flex:1;">Close</button>
                    <button class="btn btn-primary" onclick="goToSnapshots()" style="flex:1;">View Snapshots</button>
                </div>
            </div>

            <!-- Error State -->
            <div id="run-step-error" style="display:none;">
                <div style="font-size:3rem; color:var(--danger-color); margin-bottom:1rem;">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h4 style="margin-bottom:0.5rem;">Polling Failed</h4>
                <p id="run-error-msg" style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:2rem;">
                    An unknown error occurred.
                </p>
                <button class="btn btn-secondary" onclick="closeRunModal()" style="width:100%;">Close</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal -->
<div id="cluster-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Add Cluster</h3>
            <button onclick="closeModal()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="c-id">

            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="c-name" class="form-input" placeholder="e.g. cluster-01">
            </div>

            <div class="form-group">
                <label class="form-label">API URL</label>
                <input type="text" id="c-url" class="form-input" placeholder="https://api.openshift.com:6443">
            </div>

            <div class="form-group">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label class="form-label">Token</label>
                    <button class="btn btn-secondary btn-sm" onclick="showTokenHelp()"
                        style="font-size:0.7rem; padding:0.1rem 0.4rem; margin-bottom:0.3rem;">
                        <i class="fas fa-question-circle"></i> How to get token?
                    </button>
                </div>
                <input type="password" id="c-token" class="form-input" placeholder="sha256~...">
            </div>

            <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div>
                    <label class="form-label">Datacenter</label>
                    <select id="c-dc" class="form-input">
                        <option value="Azure">Azure</option>
                        <option value="HCI">HCI</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Environment</label>
                    <select id="c-env" class="form-input">
                        <option value="DEV">DEV</option>
                        <option value="UAT">UAT</option>
                        <option value="PROD">PROD</option>
                    </select>
                </div>
            </div>

            <!-- Tags Section -->
            <div class="form-group">
                <label class="form-label">Metadata Tags</label>
                <div id="tags-container" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;">
                    <!-- Tags added here -->
                </div>
                <div style="display:flex; gap:0.5rem;">
                    <input type="text" id="tag-key" class="form-input" placeholder="Key" style="flex:1;">
                    <input type="text" id="tag-val" class="form-input" placeholder="Value" style="flex:1;">
                    <button class="btn btn-secondary" onclick="addTag()">Add</button>
                </div>
            </div>

            <!-- Connection Status Area -->
            <div id="connection-status"
                style="margin-top:1rem; display:none; padding:0.75rem; border-radius:6px; font-size:0.9rem;"></div>

            <div style="display:flex; gap:1rem; margin-top:1rem;">
                <button class="btn btn-secondary" onclick="testConnection()" style="flex:1;">
                    <i class="fas fa-plug"></i> Test Connection
                </button>
                <button class="btn btn-primary" onclick="saveCluster()" style="flex:2;">
                    Save Cluster
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const IS_ADMIN = {{ 'true' if user.is_admin else 'false' }};
    // Token Help Logic
    function showTokenHelp() {
        document.getElementById('token-instructions-modal').classList.add('open');
    }

    function closeTokenHelp() {
        document.getElementById('token-instructions-modal').classList.remove('open');
    }

    function copyTokenCommands() {
        const text = document.getElementById('token-commands').innerText;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector('button[onclick="copyTokenCommands()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
            }, 2000);
        });
    }

    async function testConnection() {
        const url = document.getElementById('c-url').value;
        const token = document.getElementById('c-token').value;
        const clusterId = document.getElementById('c-id').value;
        const btn = document.querySelector('button[onclick="testConnection()"]');
        const statusDiv = document.getElementById('connection-status');

        statusDiv.style.display = 'none';
        statusDiv.className = '';

        if (!url || !token) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            statusDiv.style.color = 'var(--danger-color)';
            statusDiv.style.border = '1px solid rgba(239, 68, 68, 0.2)';
            statusDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter API URL and Token first.';
            return;
        }

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Testing...';

        try {
            const res = await fetch('/api/admin/clusters/test-connection', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    api_url: url,
                    token: token,
                    cluster_id: clusterId ? parseInt(clusterId) : null
                })
            });
            const data = await res.json();

            statusDiv.style.display = 'block';
            if (data.success) {
                statusDiv.style.background = 'rgba(16, 185, 129, 0.1)';
                statusDiv.style.color = 'var(--success-color)';
                statusDiv.style.border = '1px solid rgba(16, 185, 129, 0.2)';
                statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message}`;
            } else {
                statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                statusDiv.style.color = 'var(--danger-color)';
                statusDiv.style.border = '1px solid rgba(239, 68, 68, 0.2)';
                statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> Connection Failed: ${data.message}`;
            }
        } catch (e) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            statusDiv.style.color = 'var(--danger-color)';
            statusDiv.style.border = '1px solid rgba(239, 68, 68, 0.2)';
            statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${e.message}`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Tab Logic
    function switchTab(tabName) {
        // Update Links
        document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
        const links = Array.from(document.querySelectorAll('.tab-link'));
        const activeLink = links.find(el => el.innerText.toLowerCase().includes(tabName) ||
            el.getAttribute('onclick')?.includes(tabName));
        if (activeLink) activeLink.classList.add('active');

        // Update Content
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(`tab-${tabName}`);
        if (target) target.classList.add('active');

        // Lazy Load
        if (tabName === 'snapshots') {
            loadSnapshotsTable();
        }
    }

    // Snapshots Logic
    let _allSnapshotsGroups = [];
    let _totalRuns = 0;
    let _totalSnapshots = 0;
    let _currentPage = 0;
    const _snapshotLimit = 25;

    async function loadSnapshotsTable() {
        const tbody = document.getElementById('snapshots-table-body');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;"><i class="fas fa-circle-notch fa-spin"></i> Loading Snapshots...</td></tr>';

        // Reset selection
        const selectAll = document.getElementById('select-all-snapshots');
        if (selectAll) selectAll.checked = false;
        updateBulkDeleteButton();

        try {
            const offset = _currentPage * _snapshotLimit;
            const res = await fetch(`/api/admin/clusters/snapshots?limit=${_snapshotLimit}&offset=${offset}`);
            if (!res.ok) throw new Error("Failed to fetch snapshots");

            const data = await res.json();
            _allSnapshotsGroups = data.groups || [];
            _totalRuns = data.total_runs || 0;
            _totalSnapshots = data.total_snapshots || 0;

            // Update Totals UI
            document.getElementById('total-runs-count').innerText = _totalRuns.toLocaleString();
            document.getElementById('total-snapshots-count').innerText = _totalSnapshots.toLocaleString();

            renderSnapshotRows(_allSnapshotsGroups);
            updatePaginationControls();

        } catch (e) {
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="7" style="color:var(--danger-color); text-align:center;">Error: ${e.message}</td></tr>`;
        }
    }

    function renderSnapshotRows(groups) {
        const tbody = document.getElementById('snapshots-table-body');
        if (groups.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; opacity:0.6;">No snapshots found.</td></tr>';
            return;
        }

        tbody.innerHTML = groups.map((g, index) => {
            let ts = g.timestamp;
            if (ts && !ts.endsWith('Z') && !ts.includes('+')) ts += 'Z';

            const detailsId = `details-${index}`;

            const subRows = g.snapshots.map(s => `
<tr style="background-color: rgba(255,255,255,0.02); font-size: 0.85rem;">
    <td></td>
    <td></td>
    <td style="opacity:0.6; padding-left: 2rem;"><i class="fas fa-level-up-alt fa-rotate-90"></i> ${s.id}</td>
    <td style="color:var(--accent-color); font-weight:500;">${s.cluster_name}</td>
    <td><span class="badge ${s.status === 'Success' ? 'badge-green' : 'badge-red'}">${s.status}</span></td>
    <td style="font-family:monospace; opacity:0.8;">${s.node_count} Nodes, ${s.vcpu_count} vCPU</td>
    <td>
        ${IS_ADMIN ? `<button class="btn btn-danger btn-sm" onclick="deleteSnapshot(${s.id})" title="Delete Instance">
            <i class="fas fa-trash"></i>
        </button>` : ''}
    </td>
</tr>
`).join('');

            return `
<tr style="cursor:pointer; font-weight:600;" onclick="toggleSnapshotRow(event, '${detailsId}')">
    <td><input type="checkbox" class="snapshot-row-check" value="${g.group_id}"
            onclick="event.stopPropagation(); updateBulkDeleteButton()"></td>
    <td style="text-align:center;"><i class="fas fa-chevron-right" id="icon-${detailsId}"></i></td>
    <td><span class="badge badge-blue">Group Run</span></td>
    <td>${new Date(ts).toLocaleString('en-US', { timeZone: 'America/New_York', timeZoneName: 'short' })}</td>
    <td><span class="badge ${g.status === 'Success' ? 'badge-green' : 'badge-red'}">${g.status}</span></td>
    <td>
        <div style="font-weight:700;">${g.total_clusters} Clusters (${g.total_nodes} Nodes)</div>
        <div style="display:flex; gap:0.3rem; margin-top:0.3rem;">
            ${(g.collected_components || []).map(c => {
                let color = 'var(--accent-color)';
                let icon = 'fa-cube';
                if (c === 'Cluster') { color = '#38bdf8'; icon = 'fa-server'; }
                if (c === 'Operator') { color = '#a855f7'; icon = 'fa-boxes'; }
                if (c === 'Compliance') { color = '#10b981'; icon = 'fa-shield-alt'; }
                return `<span class="badge" style="background:rgba(255,255,255,0.05); color:${color}; border:1px solid ${color}44; font-size:0.65rem; padding:0.1rem 0.3rem; display:flex; align-items:center; gap:0.2rem;">
                            <i class="fas ${icon}" style="font-size:0.6rem;"></i> ${c}
                        </span>`;
            }).join('')}
        </div>
    </td>
    <td>
        ${IS_ADMIN ? `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteSnapshotGroup('${g.group_id}')"
            title="Delete Entire Run">
            Mass Delete
        </button>` : ''}
    </td>
</tr>
<tr id="${detailsId}" style="display:none;">
    <td colspan="7" style="padding:0; border:none;">
        <table style="width:100%; margin:0; border-collapse: collapse;">
            ${subRows}
        </table>
    </td>
</tr>
`;
        }).join('');
    }

    function toggleSnapshotRow(event, detailsId) {
        // Prevent toggle if clicking buttons
        if (event.target.closest('button') || event.target.closest('input')) return;

        const row = document.getElementById(detailsId);
        const icon = document.getElementById(`icon-${detailsId}`);
        if (row.style.display === 'none') {
            row.style.display = 'table-row';
            icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
        } else {
            row.style.display = 'none';
            icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
        }
    }

    function updatePaginationControls() {
        const container = document.getElementById('snapshot-pagination');
        if (!container) return;

        const totalPages = Math.ceil(_totalRuns / _snapshotLimit);
        if (totalPages <= 1) { container.innerHTML = ''; return; } let html = ` <button class="btn btn-secondary btn-sm"
    ${_currentPage === 0 ? 'disabled' : ''} onclick="changePage(${_currentPage - 1})">
    <i class="fas fa-chevron-left"></i> Prev
    </button>
    <span style="font-size:0.9rem; margin:0 0.5rem; opacity:0.8;">Page <strong>${_currentPage + 1}</strong> of
        ${totalPages}</span>
    <button class="btn btn-secondary btn-sm" ${(_currentPage + 1) >= totalPages ? 'disabled' : ''}
        onclick="changePage(${_currentPage + 1})">
        Next <i class="fas fa-chevron-right"></i>
    </button>
    `;
        container.innerHTML = html;
    }

    function changePage(page) {
        _currentPage = page;
        loadSnapshotsTable();
    }

    function toggleSelectAllSnapshots(el) {
        document.querySelectorAll('.snapshot-row-check').forEach(cb => cb.checked = el.checked);
        updateBulkDeleteButton();
    }

    function updateBulkDeleteButton() {
        const selected = document.querySelectorAll('.snapshot-row-check:checked');
        const btn = document.getElementById('bulk-delete-btn');
        const countSpan = document.getElementById('selected-count');

        if (selected.length > 0) {
            btn.style.display = 'flex';
            countSpan.innerText = selected.length;
        } else {
            btn.style.display = 'none';
        }
    }

    async function bulkDeleteSnapshots() {
        const selected = Array.from(document.querySelectorAll('.snapshot-row-check:checked')).map(cb => cb.value);
        if (selected.length === 0) return;

        if (!confirm(`Delete ${selected.length} snapshot runs and all their associated data? This cannot be undone.`))
            return;

        try {
            const btn = document.getElementById('bulk-delete-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Deleting...';

            const res = await fetch('/api/admin/clusters/snapshots/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_ids: selected })
            });

            if (res.ok) {
                const data = await res.json();
                loadSnapshotsTable();
                loadDbStats();
            } else {
                alert("Failed to perform bulk deletion.");
            }
        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            const btn = document.getElementById('bulk-delete-btn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (<span id="selected-count">${document.querySelectorAll('.snapshot-row-check:checked').length}</span>)`;
            }
        }
    }

    async function deleteSnapshotGroup(timestamp_str) {
        if (!confirm('Are you sure you want to delete ALL snapshots in this run?')) return;

        try {
            const res = await fetch('/api/admin/clusters/snapshots/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ group_ids: [timestamp_str] })
            });

            if (res.ok) {
                loadSnapshotsTable();
                loadDbStats();
            } else {
                alert("Failed to delete group.");
            }
        } catch (e) {
            alert(e.message);
        }
    }

    function filterSnapshotsTable(query) {
        const q = query.toLowerCase().trim();
        if (!q) {
            renderSnapshotRows(_allSnapshotsGroups);
            return;
        }

        // Client-side filter within the current group page
        const filtered = _allSnapshotsGroups.filter(g =>
            g.group_id.toLowerCase().includes(q) ||
            g.snapshots.some(s => s.cluster_name.toLowerCase().includes(q))
        );
        renderSnapshotRows(filtered);
    }

    async function massDeleteSnapshots() {
        const days = document.getElementById('cleanup-days').value;
        if (!confirm(`Are you sure you want to delete ALL snapshots older than ${days} days? This cannot be undone.`))
            return;

        try {
            const btn = document.querySelector('button[onclick="massDeleteSnapshots()"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Deleting...';

            const res = await fetch('/api/admin/clusters/snapshots/cleanup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days: parseInt(days) })
            });

            if (res.ok) {
                const data = await res.json();
                alert(`Successfully deleted ${data.deleted_count} snapshots.`);
                loadSnapshotsTable();
                loadDbStats();
            } else {
                alert("Failed to perform mass deletion.");
            }
        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            const btn = document.querySelector('button[onclick="massDeleteSnapshots()"]');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-trash-sweep"></i> Mass Delete`;
            }
        }
    }

    async function deleteSnapshot(id) {
        if (!confirm(`Delete snapshot ID ${id}? This cannot be undone.`)) return;
        try {
            const res = await fetch(`/api/admin/clusters/snapshots/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadSnapshotsTable();
                loadDbStats();
            } else {
                alert("Failed to delete snapshot.");
            }
        } catch (e) {
            alert(e.message);
        }
    }



    async function saveSchedulerConfig() {
        const interval = document.getElementById('poll-interval').value;
        const retention = document.getElementById('snapshot-retention').value;
        const cacheTtl = document.getElementById('dashboard-cache-ttl').value;
        const collectOlm = document.getElementById('collect-olm').checked;
        const runCompliance = document.getElementById('run-compliance').checked;
        const enableVacuum = document.getElementById('enable-vacuum').checked;

        try {
            const res = await fetch('/api/admin/clusters/config/scheduler', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    poll_interval_minutes: parseInt(interval),
                    snapshot_retention_days: parseInt(retention),
                    dashboard_cache_ttl_minutes: parseInt(cacheTtl),
                    collect_olm: collectOlm,
                    run_compliance: runCompliance,
                    enable_db_vacuum: enableVacuum
                })
            });
            if (res.ok) {
                alert("Scheduler configuration saved!");
            } else {
                alert("Failed to save configuration.");
            }
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    async function runSchedulerNow() {
        if (!confirm("Trigger immediate background poll? This checks all clusters and might take a minute.")) return;

        const btn = document.querySelector('button[onclick="runSchedulerNow()"]');
        const originalText = btn.innerHTML;
        const msgDiv = document.getElementById('scheduler-status-msg') || document.createElement('div');

        // Ensure msgDiv exists in DOM if not found (fallback)
        if (!document.getElementById('scheduler-status-msg')) {
            msgDiv.id = 'scheduler-status-msg';
            msgDiv.style.marginTop = '1rem';
            btn.parentElement.parentElement.appendChild(msgDiv);
        }

        // UI Loading State
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Running...';
        msgDiv.style.display = 'block';
        msgDiv.innerHTML = '<div style="color:var(--text-secondary);"><i class="fas fa-clock"></i> Polling all clusters... please wait.</div>';

        try {
            const res = await fetch('/api/admin/clusters/config/scheduler/run', { method: 'POST' });
            if (res.ok) {
                msgDiv.innerHTML = '<div style="color:var(--success-color); font-weight:600;"><i class="fas fa-check-circle"></i> Poll completed successfully!</div>';

                // Prompt to view
                setTimeout(() => {
                    if (confirm("Poll completed. View new snapshots?")) {
                        switchTab('snapshots');
                    }
                }, 500);
            } else {
                const err = await res.json();
                msgDiv.innerHTML = `<div style="color:var(--danger-color);"><i class="fas fa-exclamation-circle"></i> Failed: ${err.detail || 'Unknown error'}</div>`;
            }
        } catch (e) {
            msgDiv.innerHTML = `<div style="color:var(--danger-color);"><i class="fas fa-exclamation-circle"></i> Error: ${e.message}</div>`;
        } finally {
            // Restore button
            btn.disabled = false;
            btn.innerHTML = originalText;

            // Hide message after a while if successful
            setTimeout(() => {
                if (msgDiv.innerText.includes("successfully")) {
                    msgDiv.style.display = 'none';
                }
            }, 5000);
        }
    }
    async function openRunNowModal() {
        // Reset state
        document.getElementById('run-step-confirm').style.display = 'block';
        document.getElementById('run-step-loading').style.display = 'none';
        document.getElementById('run-step-success').style.display = 'none';
        document.getElementById('run-step-error').style.display = 'none';
        document.getElementById('run-modal-close').style.display = 'block';

        document.getElementById('run-now-modal').classList.add('open');
    }

    function closeRunModal() {
        document.getElementById('run-now-modal').classList.remove('open');
    }

    function goToSnapshots() {
        closeRunModal();
        switchTab('snapshots');
    }

    let _runTimerInterval;
    let _pollErrorTimeout;

    function startRunTimer() {
        if (_runTimerInterval) clearInterval(_runTimerInterval);
        let sec = 0;
        const el = document.getElementById('run-timer');
        el.innerText = "00:00";
        _runTimerInterval = setInterval(() => {
            sec++;
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            el.innerText = `${m}:${s}`;
        }, 1000);
    }

    function updateRunStep(stepNum) {
        // Reset all
        [1, 2, 3, 4].forEach(i => {
            const el = document.getElementById(`step-${i}`);
            const icon = el.querySelector('.step-icon');
            if (i < stepNum) {
                el.classList.add('completed');
                el.classList.remove('active');
                icon.innerHTML = '<i class="fas fa-check"></i>';
            } else if (i === stepNum) {
                el.classList.add('active');
                el.classList.remove('completed');
                icon.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            } else {
                el.classList.remove('active', 'completed');
                icon.innerHTML = '<i class="fas fa-circle"></i>';
            }
        });
    }

    async function confirmRunNow() {
        // Switch to loading
        document.getElementById('run-step-confirm').style.display = 'none';
        document.getElementById('run-step-loading').style.display = 'block';
        document.getElementById('run-modal-close').style.display = 'none';

        const clusterEl = document.getElementById('run-current-cluster');
        const indexEl = document.getElementById('run-cluster-index');
        const resourceEl = document.getElementById('run-current-resource');
        const progressBar = document.getElementById('run-progress-bar');

        // Reset indicators
        clusterEl.innerText = 'Connecting...';
        indexEl.innerText = '-/-';
        resourceEl.innerText = 'Initializing stream...';
        progressBar.style.width = '0%';

        startRunTimer();
        updateRunStep(1);

        const eventSource = new EventSource('/api/admin/clusters/config/scheduler/run-stream');

        eventSource.onmessage = function (event) {
            const data = JSON.parse(event.data);

            if (data.type === 'cluster_start') {
                clusterEl.innerText = data.cluster;
                indexEl.innerText = `${data.index}/${data.total}`;
                const pct = (data.index / data.total) * 100;
                progressBar.style.width = `${pct}%`;
                updateRunStep(2);
            } else if (data.type === 'resource_start') {
                resourceEl.innerText = `${data.resource}...`;

                const res = data.resource.toLowerCase();
                if (['csvs', 'subscriptions'].includes(res)) {
                    updateRunStep(3);
                } else if (res.includes('compliance')) {
                    updateRunStep(4);
                } else if (['nodes', 'projects', 'machines'].includes(res)) {
                    updateRunStep(2);
                }

            } else if (data.type === 'error') {
                console.error("Poll Error:", data.message);
                resourceEl.innerText = `Error: ${data.message}`;
            } else if (data.type === 'done') {
                eventSource.close();
                clearInterval(_runTimerInterval);
                document.getElementById('run-step-loading').style.display = 'none';
                document.getElementById('run-step-success').style.display = 'block';
                document.getElementById('run-modal-close').style.display = 'block';
            }
        };

        eventSource.onerror = function (err) {
            // Heartbeats (SSE comments) keep the connection open but don't fire message events.
            // If we get here, the connection actually dropped or failed.
            console.warn("SSE Connection issue, will retry automatically...");

            // If the modal is still loading after a long time without updates, then show error.
            // But we let EventSource try to auto-reconnect first.
            if (!_pollErrorTimeout) {
                _pollErrorTimeout = setTimeout(() => {
                    if (document.getElementById('run-step-loading').style.display !== 'none') {
                        eventSource.close();
                        clearInterval(_runTimerInterval);
                        document.getElementById('run-step-loading').style.display = 'none';
                        document.getElementById('run-step-error').style.display = 'block';
                        document.getElementById('run-error-msg').innerText = "The connection to the background job was lost. It might still be running; please check the snapshots page in a few minutes.";
                        document.getElementById('run-modal-close').style.display = 'block';
                    }
                }, 30000); // 30s grace for reconnection
            }
        };
    }

    let currentTags = {};

    function renderTags() {
        const container = document.getElementById('tags-container');
        container.innerHTML = '';
        for (const [k, v] of Object.entries(currentTags)) {
            const tag = document.createElement('span');
            tag.className = 'badge';
            tag.style.background = 'var(--bg-primary)';
            tag.style.border = '1px solid var(--border-color)';
            tag.innerHTML = `${k}=${v} <i class="fas fa-times" onclick="removeTag('${k}')"
        style="cursor:pointer; margin-left:0.3rem; opacity:0.6;"></i>`;
            container.appendChild(tag);
        }
    }

    function addTag() {
        const k = document.getElementById('tag-key').value.trim();
        const v = document.getElementById('tag-val').value.trim();
        if (k && v) {
            currentTags[k] = v;
            document.getElementById('tag-key').value = '';
            document.getElementById('tag-val').value = '';
            renderTags();
        }
    }

    window.removeTag = function (k) {
        delete currentTags[k];
        renderTags();
    }

    function openModal() {
        document.getElementById('c-id').value = '';
        document.getElementById('c-name').value = '';
        document.getElementById('c-url').value = '';
        document.getElementById('c-token').value = '';
        document.getElementById('modal-title').innerText = "Add Cluster";

        // Reset status
        const statusDiv = document.getElementById('connection-status');
        if (statusDiv) statusDiv.style.display = 'none';

        currentTags = {};
        renderTags();
        document.getElementById('cluster-modal').classList.add('open');
    }

    function closeModal() {
        document.getElementById('cluster-modal').classList.remove('open');
    }

    async function editCluster(id) {
        const res = await fetch(`/api/admin/clusters/${id}`);
        const c = await res.json();

        document.getElementById('c-id').value = c.id;
        document.getElementById('c-name').value = c.name;
        document.getElementById('c-url').value = c.api_url;
        document.getElementById('c-token').value = c.token; // usually hidden
        document.getElementById('c-dc').value = c.datacenter || 'Azure';
        document.getElementById('c-env').value = c.environment || 'DEV';

        // Reset status
        const statusDiv = document.getElementById('connection-status');
        if (statusDiv) statusDiv.style.display = 'none';

        try {
            currentTags = JSON.parse(c.tags || '{}');
        } catch (e) { currentTags = {}; }
        renderTags();

        document.getElementById('modal-title').innerText = "Edit Cluster";
        document.getElementById('cluster-modal').classList.add('open');
    }

    async function saveCluster() {
        const id = document.getElementById('c-id').value;
        const method = id ? 'PATCH' : 'POST';
        const url = id ? `/api/admin/clusters/${id}` : '/api/admin/clusters/';

        const data = {
            name: document.getElementById('c-name').value,
            api_url: document.getElementById('c-url').value,
            token: document.getElementById('c-token').value,
            datacenter: document.getElementById('c-dc').value,
            environment: document.getElementById('c-env').value,
            tags: JSON.stringify(currentTags)
        };

        await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        window.location.reload();
    }

    async function deleteCluster(id) {
        if (confirm("Delete cluster?")) {
            await fetch(`/api/admin/clusters/${id}`, { method: 'DELETE' });
            window.location.reload();
        }
    }
    // Initialize from URL
    switchTab('{{ active_tab }}');

    // Missing function to prevent errors
    async function loadDbStats() {
        // Since we are on the admin page, we might want to refresh global stats if they were visible.
        // For now, this placeholder prevents ReferenceErrors after deletion.
        console.log("Reloading DB stats...");
        try {
            // Optional: Fetch if we want to log or update a future widget
            // const res = await fetch('/api/admin/db-stats'); 
        } catch (e) { console.error(e); }
    }
</script>

<!-- Token Instructions Modal -->
<div id="token-instructions-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-key"></i> Create Connection Token</h3>
            <button onclick="closeTokenHelp()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <p style="font-size:0.9rem; margin-bottom:1rem; opacity:0.8;">Run these commands via <code>oc</code> CLI
                to create a long-lived service account token for the inventory app:</p>

            <div
                style="position:relative; background:#0f172a; border-radius:8px; padding:1rem; border:1px solid var(--border-color); margin-bottom:1.5rem;">
                <pre id="token-commands"
                    style="font-size:0.85rem; color:#cbd5e1; margin:0; line-height:1.4; overflow-x:auto;"># Create service account
oc create serviceaccount -n default ocp-inventory

# Create long-lived token
oc create -f - &lt;&lt;EOF
apiVersion: v1
kind: Secret
metadata:
  name: ocp-inventory-sa-token
  namespace: default
  annotations:
    kubernetes.io/service-account.name: ocp-inventory
type: kubernetes.io/service-account-token
EOF

# Grant cluster-reader role
oc adm policy add-cluster-role-to-user cluster-reader -n default -z ocp-inventory

# Show token
oc get secret/ocp-inventory-sa-token -n default -o jsonpath={.data.token}|base64 -d</pre>
                <button class="btn btn-secondary btn-sm" onclick="copyTokenCommands()"
                    style="position:absolute; top:0.5rem; right:0.5rem; opacity:0.8;">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>

            <div
                style="background:rgba(56, 189, 248, 0.05); padding:1rem; border-radius:8px; border-left:4px solid var(--accent-color); font-size:0.85rem;">
                <p style="margin:0;"><i class="fas fa-info-circle"></i> <strong>Note:</strong> Starting with
                    OpenShift 4.11, ServiceAccount tokens no longer expire by default ONLY if created via a manual
                    Secret as shown above. The token retrieved in the last step should be pasted into the Token
                    field.</p>
            </div>
        </div>
        <div class="modal-footer"
            style="padding-top:1.5rem; border-top:1px solid var(--border-color); margin-top:1.5rem; display:flex; justify-content:flex-end;">
            <button class="btn btn-primary" onclick="closeTokenHelp()">Got it</button>
        </div>
    </div>
</div>
{% endblock %}