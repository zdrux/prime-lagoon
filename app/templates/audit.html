{% extends "base.html" %}

{% block content %}
<style>
    .multi-select-container {
        position: relative;
    }

    .multi-select-trigger {
        cursor: pointer;
        background-color: var(--bg-primary);
    }

    .multi-select-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        z-index: 100;
        max-height: 200px;
        overflow-y: auto;
        padding: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .multi-select-options.open {
        display: block;
    }

    .multi-select-options label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.3rem 0.5rem;
        cursor: pointer;
        font-size: 0.9rem;
        border-radius: 4px;
    }

    .multi-select-options label:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    /* Expandable Bundle Styles */
    .bundle-card {
        transition: all 0.3s ease;
    }

    .bundle-header {
        cursor: pointer;
        user-select: none;
    }

    .bundle-header:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .bundle-toggle-icon {
        transition: transform 0.3s ease;
        margin-right: 0.75rem;
        opacity: 0.5;
    }

    .bundle-card.open .bundle-toggle-icon {
        transform: rotate(180deg);
        opacity: 1;
        color: var(--accent-color);
    }

    .bundle-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
    }

    .bundle-card.open .bundle-content {
        max-height: 2000px;
        /* Large enough to fit content */
        transition: max-height 0.4s cubic-bezier(1, 0, 1, 0);
    }

    .bundle-stats {
        font-size: 0.75rem;
        opacity: 0.6;
        margin-left: auto;
        margin-right: 1.5rem;
    }

    .rule-suspended {
        opacity: 0.5;
        background: rgba(255, 255, 255, 0.02);
    }

    .rule-suspended td {
        color: var(--text-secondary);
    }
</style>
<div class="page-header">
    <h1 class="page-title">Compliance Rules</h1>
    <div style="display:flex; gap:1rem; align-items:center;">
        <div style="position:relative;">
            <i class="fas fa-search"
                style="position:absolute; left:0.75rem; top:50%; transform:translateY(-50%); font-size:0.8rem; color:var(--text-secondary);"></i>
            <input type="text" id="rule-search" placeholder="Search rules..."
                style="padding:0.35rem 0.75rem 0.35rem 2rem; border-radius:15px; background:var(--bg-primary); border:1px solid var(--border-color); color:var(--text-primary); font-size:0.8rem; width:220px;"
                oninput="filterRules()">
        </div>
        {% if user.is_admin %}
        <button class="btn btn-secondary" onclick="openExportModal()">
            <i class="fas fa-file-export"></i> Export Rules
        </button>
        <button class="btn btn-secondary" onclick="openImportModal()">
            <i class="fas fa-file-import"></i> Import Rules
        </button>
        <button class="btn btn-secondary" onclick="openBundleModal()">
            <i class="fas fa-box"></i> New Bundle
        </button>
        <button class="btn btn-secondary" onclick="openRuleModal()">
            <i class="fas fa-plus"></i> New Ad-hoc Rule
        </button>
        {% endif %}
    </div>
</div>

<!-- Bundles Section -->
<div id="bundles-container">
    {% for bundle in bundles %}
    <div class="card fade-in bundle-card" style="margin-bottom: 1rem;" id="bundle-card-{{ bundle.id }}">
        <!-- Header acting as Toggle -->
        <div class="resource-header bundle-header" onclick="toggleBundle('bundle-card-{{ bundle.id }}')"
            style="padding:0.75rem 1rem; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; flex:1;">
                <i class="fas fa-chevron-down bundle-toggle-icon"></i>
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <i class="fas fa-box" style="color:var(--accent-color); font-size:0.9rem;"></i>
                    <span style="font-weight:700; font-size:1rem;">{{ bundle.name }}</span>
                    {% if bundle.match_datacenter %}<span class="badge badge-blue">{{ bundle.match_datacenter
                        }}</span>{% endif %}
                    {% if bundle.match_environment %}<span class="badge badge-green">{{ bundle.match_environment
                        }}</span>{% endif %}

                    <!-- Display Tags -->
                    {% if bundle.tags %}
                    {% set tags = bundle.tags | fromjson %}
                    {% for k,v in tags.items() %}
                    <span class="badge"
                        style="background:rgba(255,255,255,0.03); border:1px solid var(--border-color); font-size:0.7em;">{{
                        k }}={{ v }}</span>
                    {% endfor %}
                    {% endif %}
                </div>

                <!-- Fast Stats -->
                <div class="bundle-stats">
                    {% set rule_count = rules | selectattr('bundle_id', 'equalto', bundle.id) | list | length %}
                    {{ rule_count }} {{ 'Rule' if rule_count == 1 else 'Rules' }}
                </div>
            </div>

            <!-- Actions (Stopped from bubbling) -->
            <div style="display:flex; gap:0.4rem;" onclick="event.stopPropagation()">
                {% if user.is_admin %}
                <button class="btn btn-secondary btn-bundle-edit" data-id="{{ bundle.id }}"
                    data-name="{{ bundle.name | replace('"', ' &quot;') }}"
                    data-dc="{{ bundle.match_datacenter or '' }}" data-env="{{ bundle.match_environment or '' }}"
                    data-tags="{{ bundle.tags or '{}' }}" style="padding:0.25rem 0.5rem; font-size:0.75rem;"
                    title="Edit Bundle Details">
                    <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn btn-secondary" onclick="openRuleModal({{ bundle.id }})"
                    style="padding:0.25rem 0.5rem; font-size:0.75rem;" title="Add Rule to this Bundle">
                    <i class="fas fa-plus"></i> Rule
                </button>
                <button class="btn btn-danger" onclick="deleteBundle({{ bundle.id }})"
                    style="padding:0.25rem 0.5rem; font-size:0.75rem;" title="Delete Bundle">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
            </div>
        </div>

        <div class="bundle-content">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width:20%;">Rule Name</th>
                            <th style="width:20%;">Resource</th>
                            <th style="width:25%;">Logic</th>
                            <th style="width:20%;">Actions</th>
                            <th style="width:15%; text-align:center;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set ns = namespace(count=0) %}
                        {% for rule in rules | sort(attribute='name') if rule.bundle_id == bundle.id %}
                        {% set ns.count = ns.count + 1 %}
                        <tr class="{% if not rule.is_enabled %}rule-suspended{% endif %}">
                            <td>
                                {{ rule.name }}
                                {% if not rule.is_enabled %}
                                <br><small style="color:var(--danger-color); font-weight:bold;">(SUSPENDED)</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ rule.resource_kind }}
                                {% if rule.match_resource_name %}
                                <br><small style="color:var(--accent-color);">Name: {{ rule.match_resource_name
                                    }}</small>
                                {% endif %}
                                <br><small style="opacity:0.6;">({{ rule.api_version }})</small>
                            </td>
                            <td>
                                <div style="display:flex; flex-direction:column; gap:0.3rem;">
                                    <div>
                                        {% if rule.check_type == 'VALIDATION' %}
                                        <span class="badge badge-blue">{{ rule.operator }}</span>
                                        <code style="font-size:0.8em;">{{ rule.field_path }}</code>
                                        {% if rule.expected_value %}
                                        <span style="font-weight:bold;">= {{ rule.expected_value | truncate(64)
                                            }}</span>
                                        {% endif %}
                                        {% elif rule.check_type == 'EXISTENCE' %}
                                        <span class="badge badge-purple">EXISTENCE</span>
                                        {% if rule.operator == 'contains' %}
                                        <span style="font-size:0.85em;">Name contains <b>{{ rule.match_resource_name
                                                }}</b></span>
                                        {% else %}
                                        <span style="font-size:0.85em;">Name equals <b>{{ rule.match_resource_name
                                                }}</b></span>
                                        {% endif %}
                                        {% elif rule.check_type == 'FORBIDDANCE' %}
                                        <span class="badge badge-red">FORBIDDANCE</span>
                                        {% if rule.operator == 'contains' %}
                                        <span style="font-size:0.85em;">Name contains <b>{{ rule.match_resource_name
                                                }}</b></span>
                                        {% else %}
                                        <span style="font-size:0.85em;">Name equals <b>{{ rule.match_resource_name
                                                }}</b></span>
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                    {% if rule.check_type == 'VALIDATION' and rule.extra_conditions %}
                                    {% set extras = rule.extra_conditions | fromjson %}
                                    {% for cond in extras %}
                                    <div
                                        style="display:flex; align-items:center; gap:0.5rem; font-size:0.8rem; opacity:0.8;">
                                        <span style="color:var(--accent-color); font-weight:700; width:30px;">{{
                                            rule.condition_logic }}</span>
                                        <span class="badge"
                                            style="background:var(--bg-primary); border:1px solid var(--border-color); font-size:0.75rem; padding:0.1rem 0.3rem;">{{
                                            cond.op }}</span>
                                        <code>{{ cond.path }}</code>
                                        {% if cond.val %}<b>= {{ cond.val | truncate(64) }}</b>{% endif %}
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div style="display:flex; gap:0.4rem;">
                                    {% if user.is_admin %}
                                    <button class="btn btn-secondary btn-rule-edit" data-id="{{ rule.id }}"
                                        data-bundle-id="{{ bundle.id }}" data-name="{{ rule.name }}"
                                        data-kind="{{ rule.resource_kind }}" data-api="{{ rule.api_version }}"
                                        data-ns="{{ rule.namespace or "" }}" data-path="{{ rule.field_path }}"
                                        data-op="{{ rule.operator }}" data-val="{{ rule.expected_value or "" }}"
                                        data-res-name="{{ rule.match_resource_name or "" }}"
                                        data-logic="{{ rule.condition_logic }}" data-check-type="{{ rule.check_type }}"
                                        data-extras="{{ rule.extra_conditions or '[]' }}"
                                        data-enabled="{{ 'true' if rule.is_enabled else 'false' }}"
                                        style="padding:0.2rem 0.5rem;" title="Edit Rule">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-secondary" onclick="duplicateRule({{ rule.id }})"
                                        style="padding:0.2rem 0.5rem;" title="Duplicate Rule">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteRule({{ rule.id }})"
                                        style="padding:0.2rem 0.5rem;" title="Delete Rule">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                            <td style="text-align:center;">
                                <button class="btn {{ 'btn-secondary' if rule.is_enabled else 'btn-danger' }}" {% if
                                    user.is_admin %} onclick="toggleRuleStatus({{ rule.id }})" {% else %} disabled
                                    style="opacity:0.6; cursor:not-allowed; padding:0.3rem 0.75rem; min-width:80px; font-size:0.75rem;"
                                    {% endif %} {% if user.is_admin %}
                                    style="padding:0.3rem 0.75rem; min-width:80px; font-size:0.75rem;" {% endif %}
                                    title="{{ 'Suspend Rule' if rule.is_enabled else 'Activate Rule' }}">
                                    {% if rule.is_enabled %}
                                    <i class="fas fa-pause" style="margin-right:0.3rem;"></i> Active
                                    {% else %}
                                    <i class="fas fa-play" style="margin-right:0.3rem;"></i> Paused
                                    {% endif %}
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if ns.count == 0 %}
                        <tr>
                            <td colspan="4" style="text-align:center; opacity:0.6; padding:0.5rem;">No rules in this
                                bundle.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div id="no-bundles-message" style="display:none; text-align:center; padding:2rem; opacity:0.6;">
    No bundles matching your search.
</div>

<!-- Ad-hoc Rules -->
<div class="card fade-in" style="margin-top: 2rem;">
    <div class="resource-header" style="padding:1rem; border-bottom:1px solid var(--border-color); font-weight:700;">
        Ad-hoc Rules
    </div>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width:15%;">Rule Name</th>
                    <th style="width:15%;">Resource</th>
                    <th style="width:25%;">Logic</th>
                    <th style="width:15%;">Scope</th>
                    <th style="width:20%;">Actions</th>
                    <th style="width:10%; text-align:center;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% set ns = namespace(count=0) %}
                {% for rule in rules | sort(attribute='name') if not rule.bundle_id %}
                {% set ns.count = ns.count + 1 %}
                <tr class="{% if not rule.is_enabled %}rule-suspended{% endif %}">
                    <td>
                        {{ rule.name }}
                        {% if not rule.is_enabled %}
                        <br><small style="color:var(--danger-color); font-weight:bold;">(SUSPENDED)</small>
                        {% endif %}
                    </td>
                    <td>
                        {{ rule.resource_kind }}
                        {% if rule.match_resource_name %}
                        <br><small style="color:var(--accent-color);">Name: {{ rule.match_resource_name }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display:flex; flex-direction:column; gap:0.3rem;">
                            <div>
                                {% if rule.check_type == 'VALIDATION' or not rule.check_type %}
                                <span class="badge badge-blue">{{ rule.operator }}</span>
                                <code>{{ rule.field_path }}</code>
                                {% if rule.expected_value and rule.operator == 'equals' %}
                                <span style="font-weight:bold;">= {{ rule.expected_value | truncate(64) }}</span>
                                {% endif %}
                                {% elif rule.check_type == 'EXISTENCE' %}
                                <span class="badge badge-purple">EXISTENCE</span>
                                {% if rule.operator == 'contains' %}
                                <span style="font-size:0.85em;">Name contains <b>{{ rule.match_resource_name
                                        }}</b></span>
                                {% else %}
                                <span style="font-size:0.85em;">Name equals <b>{{ rule.match_resource_name }}</b></span>
                                {% endif %}
                                {% elif rule.check_type == 'FORBIDDANCE' %}
                                <span class="badge badge-red">FORBIDDANCE</span>
                                {% if rule.operator == 'contains' %}
                                <span style="font-size:0.85em;">Name contains <b>{{ rule.match_resource_name
                                        }}</b></span>
                                {% else %}
                                <span style="font-size:0.85em;">Name equals <b>{{ rule.match_resource_name }}</b></span>
                                {% endif %}
                                {% endif %}
                            </div>
                            {% if rule.check_type == 'VALIDATION' and rule.extra_conditions %}
                            {% set extras = rule.extra_conditions | fromjson %}
                            {% for cond in extras %}
                            <div style="display:flex; align-items:center; gap:0.5rem; font-size:0.8rem; opacity:0.8;">
                                <span style="color:var(--accent-color); font-weight:700; width:30px;">{{
                                    rule.condition_logic }}</span>
                                <span class="badge"
                                    style="background:var(--bg-primary); border:1px solid var(--border-color); font-size:0.75rem; padding:0.1rem 0.3rem;">{{
                                    cond.op }}</span>
                                <code>{{ cond.path }}</code>
                                {% if cond.val %}<b>= {{ cond.val | truncate(64) }}</b>{% endif %}
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if rule.match_datacenter %}<span class="badge badge-blue">{{ rule.match_datacenter
                            }}</span>{% endif %}
                        {% if rule.match_environment %}<span class="badge badge-green">{{ rule.match_environment
                            }}</span>{% endif %}
                        {% if rule.tags %}
                        {% set tags = rule.tags | fromjson %}
                        {% for k,v in tags.items() %}
                        <span class="badge"
                            style="background:var(--bg-secondary); border:1px solid var(--border-color); font-size:0.7em;">{{
                            k }}={{ v }}</span>
                        {% endfor %}
                        {% endif %}
                        {% if not rule.match_datacenter and not rule.match_environment and not rule.tags %}All{% endif
                        %}
                    </td>
                    <td>
                        <div style="display:flex; gap:0.4rem;">
                            {% if user.is_admin %}
                            <button class="btn btn-secondary btn-rule-edit" data-id="{{ rule.id }}" data-bundle-id=""
                                data-name="{{ rule.name }}" data-kind="{{ rule.resource_kind }}"
                                data-api="{{ rule.api_version }}" data-ns="{{ rule.namespace or "" }}"
                                data-path="{{ rule.field_path }}" data-op="{{ rule.operator }}"
                                data-val="{{ rule.expected_value or '' }}" data-dc="{{ rule.match_datacenter or '' }}"
                                data-env="{{ rule.match_environment or '' }}" data-tags="{{ rule.tags or '{}' }}"
                                data-res-name="{{ rule.match_resource_name or '' }}"
                                data-logic="{{ rule.condition_logic }}" data-check-type="{{ rule.check_type }}"
                                data-extras="{{ rule.extra_conditions or '[]' }}"
                                data-enabled="{{ 'true' if rule.is_enabled else 'false' }}"
                                style="padding:0.2rem 0.5rem;" title="Edit Rule">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-secondary" onclick="duplicateRule({{ rule.id }})"
                                style="padding:0.2rem 0.5rem;" title="Duplicate Rule">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteRule({{ rule.id }})"
                                style="padding:0.2rem 0.5rem;" title="Delete Rule">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                    <td style="text-align:center;">
                        <button class="btn {{ 'btn-secondary' if rule.is_enabled else 'btn-danger' }}" {% if
                            user.is_admin %} onclick="toggleRuleStatus({{ rule.id }})" {% else %} disabled
                            style="opacity:0.6; cursor:not-allowed; padding:0.3rem 0.5rem; min-width:70px; font-size:0.75rem;"
                            {% endif %} {% if user.is_admin %}
                            style="padding:0.3rem 0.5rem; min-width:70px; font-size:0.75rem;" {% endif %}
                            title="{{ 'Suspend Rule' if rule.is_enabled else 'Activate Rule' }}">
                            {% if rule.is_enabled %}
                            <i class="fas fa-pause"></i>
                            {% else %}
                            <i class="fas fa-play"></i>
                            {% endif %}
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% if ns.count == 0 %}
                <tr>
                    <td colspan="5" style="text-align:center; opacity:0.6;">No ad-hoc rules.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Bundle Modal -->
<div id="bundle-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="bundle-modal-title">Create Audit Bundle</h3>
            <button onclick="closeBundleModal()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="b-id">
            <div class="form-group">
                <label class="form-label">Bundle Name</label>
                <input type="text" id="b-name" class="form-input">
            </div>
            <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div>
                    <label class="form-label">Datacenter Scope</label>
                    <select id="b-dc" class="form-input">
                        <option value="">All</option>
                        <option value="Azure">Azure</option>
                        <option value="HCI">HCI</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Environment Scope</label>
                    <div class="multi-select-container" id="b-env-container">
                        <input type="text" class="form-input multi-select-trigger" id="b-env-trigger" readonly
                            placeholder="All" onclick="toggleMultiSelect('b-env')">
                        <div class="multi-select-options" id="b-env-options">
                            <label><input type="checkbox" value="All" onchange="handleAllSelection('b-env', this)">
                                All</label>
                            <label><input type="checkbox" value="DEV" onchange="updateMultiSelectValue('b-env')">
                                DEV</label>
                            <label><input type="checkbox" value="UAT" onchange="updateMultiSelectValue('b-env')">
                                UAT</label>
                            <label><input type="checkbox" value="PROD" onchange="updateMultiSelectValue('b-env')">
                                PROD</label>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tags Section -->
            <div class="form-group">
                <label class="form-label">Metadata Tags Scope (Subset Match)</label>
                <div id="b-tags-container" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;">
                </div>
                <div style="display:flex; gap:0.5rem;">
                    <input type="text" id="b-tag-key" class="form-input" placeholder="Key" style="flex:1;">
                    <input type="text" id="b-tag-val" class="form-input" placeholder="Value" style="flex:1;">
                    <button class="btn btn-secondary" onclick="addTag('b')">Add</button>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="showMatches('b')"
                style="width:100%; margin-bottom:1rem; border:1px dashed var(--border-color);">
                <i class="fas fa-search"></i> Show Matching Clusters
            </button>
            <div id="b-matches" style="margin-bottom:1rem; font-size:0.9rem; color:var(--text-secondary);"></div>

            <button class="btn btn-primary" onclick="submitBundle()" style="width:100%;">Save Bundle</button>
        </div>
    </div>
</div>

<!-- Rule Modal -->
<div id="rule-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="rule-modal-title">Add Rule</h3>
            <button onclick="closeRuleModal()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="r-id"> <!-- For Edit -->
            <input type="hidden" id="r-bundle-id"> <!-- For Context -->

            <div class="form-group"
                style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; background: rgba(52, 211, 153, 0.1); padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(52, 211, 153, 0.2);">
                <input type="checkbox" id="r-enabled" style="width: 1.2rem; height: 1.2rem; cursor: pointer;">
                <label for="r-enabled" style="font-weight: 600; cursor: pointer; color: #34d399;">Rule is Active</label>
                <small style="margin-left: auto; opacity: 0.7;">Suspended rules are skipped during audits.</small>
            </div>

            <div class="form-group">
                <label class="form-label">Rule Name</label>
                <input type="text" id="r-name" class="form-input">
            </div>

            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div>
                    <label class="form-label">Resource Kind</label>
                    <input type="text" id="r-kind" class="form-input" placeholder="e.g. ConfigMap">
                </div>
                <div>
                    <label class="form-label">API Version</label>
                    <input type="text" id="r-api" class="form-input" placeholder="e.g. v1">
                </div>
                <div>
                    <label class="form-label">Namespace (Opt)</label>
                    <input type="text" id="r-ns" class="form-input" placeholder="e.g. default">
                </div>
            </div>

            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label class="form-label">Check Type</label>
                    <select id="r-check-type" class="form-input" onchange="toggleCheckTypeFields()">
                        <option value="VALIDATION">Field Validation</option>
                        <option value="EXISTENCE">Existence Check</option>
                        <option value="FORBIDDANCE">Forbiddance Check</option>
                    </select>
                </div>
                <div id="r-res-name-container">
                    <label class="form-label">Resource Name (Optional for Validation)</label>
                    <input type="text" id="r-name-match" class="form-input" placeholder="e.g. managed-csi">
                </div>
            </div>

            <div id="r-validation-logic-group">
                <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                    <div>
                        <label class="form-label">Field Path (JSON Path)</label>
                        <input type="text" id="r-path" class="form-input">
                        <small style="opacity:0.6;">Use quotes for keys with dots, e.g.
                            <code>metadata.annotations."key.with.dot"</code></small>
                    </div>
                </div>

                <div class="form-group" style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                    <div>
                        <label class="form-label">Operator</label>
                        <select id="r-op" class="form-input">
                            <option value="equals">Equals</option>
                            <option value="exists">Exists</option>
                            <option value="contains">Contains</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Expected Value</label>
                        <input type="text" id="r-val" class="form-input">
                    </div>
                </div>
            </div>

            <div id="r-existence-logic-group" style="display:none;">
                <div class="form-group">
                    <label class="form-label">Name Matching Logic</label>
                    <select id="r-op-existence" class="form-input" onchange="syncExistenceOp(this)">
                        <option value="equals">Equals (Exact Name Match)</option>
                        <option value="contains">Contains (Substring Match)</option>
                    </select>
                </div>
            </div>

            <div
                style="margin: 1.5rem 0; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4
                        style="margin:0; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-secondary);">
                        Advanced Conditions</h4>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size:0.8rem; opacity:0.8;">Logic:</span>
                        <select id="r-logic" class="form-input"
                            style="padding: 0.2rem 0.5rem; width: auto; font-size: 0.8rem;">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                        </select>
                    </div>
                </div>

                <div id="extra-conditions-container" style="margin-bottom: 1rem;">
                    <!-- Rows injected here -->
                </div>

                <button class="btn btn-secondary" onclick="addExtraConditionRow()"
                    style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                    <i class="fas fa-plus"></i> Add Condition
                </button>
            </div>

            <div id="r-scope-section">
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label class="form-label">Datacenter (Optional)</label>
                        <select id="r-dc" class="form-input">
                            <option value="">All</option>
                            <option value="Azure">Azure</option>
                            <option value="HCI">HCI</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Environment (Optional)</label>
                        <div class="multi-select-container" id="r-env-container">
                            <input type="text" class="form-input multi-select-trigger" id="r-env-trigger" readonly
                                placeholder="All" onclick="toggleMultiSelect('r-env')">
                            <div class="multi-select-options" id="r-env-options">
                                <label><input type="checkbox" value="All" onchange="handleAllSelection('r-env', this)">
                                    All</label>
                                <label><input type="checkbox" value="DEV" onchange="updateMultiSelectValue('r-env')">
                                    DEV</label>
                                <label><input type="checkbox" value="UAT" onchange="updateMultiSelectValue('r-env')">
                                    UAT</label>
                                <label><input type="checkbox" value="PROD" onchange="updateMultiSelectValue('r-env')">
                                    PROD</label>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Tags Section -->
                <div class="form-group">
                    <label class="form-label">Metadata Tags Scope</label>
                    <div id="r-tags-container" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;">
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                        <input type="text" id="r-tag-key" class="form-input" placeholder="Key" style="flex:1;">
                        <input type="text" id="r-tag-val" class="form-input" placeholder="Value" style="flex:1;">
                        <button class="btn btn-secondary" onclick="addTag('r')">Add</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="showMatches('r')"
                    style="width:100%; margin-bottom:1rem; border:1px dashed var(--border-color);">
                    <i class="fas fa-search"></i> Show Matching Clusters
                </button>
                <div id="r-matches" style="margin-bottom:1rem; font-size:0.9rem; color:var(--text-secondary);"></div>
            </div>

            <div style="text-align: right; margin-top: 1.5rem;">
                <button class="btn btn-secondary" onclick="closeRuleModal()"
                    style="margin-right: 0.5rem;">Cancel</button>
                <button class="btn btn-primary" onclick="submitRule()">Save Rule</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div id="export-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>Export Rules</h3>
            <button onclick="closeExportModal()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:1.5rem; opacity:0.8;">Select the bundles and ad-hoc rules you wish to export as a
                JSON file.</p>

            <div style="margin-bottom:1rem; display:flex; gap:1rem; align-items:center;">
                <button class="btn btn-secondary" onclick="exportSelectAll(true)"
                    style="padding:0.4rem 0.8rem; font-size:0.8rem;">Select All</button>
                <button class="btn btn-secondary" onclick="exportSelectAll(false)"
                    style="padding:0.4rem 0.8rem; font-size:0.8rem;">Deselect All</button>
            </div>

            <div id="export-list"
                style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.1); border-radius: 8px; padding: 1rem; border: 1px solid var(--border-color);">
                <!-- Populated by JS -->
            </div>

            <div style="text-align: right; margin-top: 1.5rem; display:flex; justify-content:flex-end; gap:0.5rem;">
                <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="downloadExport()">
                    <i class="fas fa-download"></i> Download Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3>Import Rules</h3>
            <button onclick="closeImportModal()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div id="import-upload-section">
                <div style="border: 2px dashed var(--border-color); padding: 3rem; text-align: center; border-radius: 12px; transition: border-color 0.2s; cursor: pointer;"
                    onclick="document.getElementById('import-file-input').click()"
                    onmouseover="this.style.borderColor='var(--accent-color)'"
                    onmouseout="this.style.borderColor='var(--border-color)'">
                    <i class="fas fa-cloud-upload-alt fa-3x" style="margin-bottom:1rem; opacity:0.5;"></i>
                    <h4>Click to upload export file</h4>
                    <p style="opacity:0.6; font-size:0.9rem;">Select the .json file you previously exported.</p>
                    <input type="file" id="import-file-input" style="display:none;" accept=".json"
                        onchange="handleImportFile(this)">
                </div>
            </div>

            <div id="import-preview-section" style="display:none;">
                <p style="margin-bottom:1rem; opacity:0.8;">Review the items to be imported. Conflicts indicate names
                    already present in the database.</p>
                <div id="import-preview-table-container" style="max-height: 400px; overflow-y: auto;">
                    <!-- Table populated by JS -->
                </div>
                <div style="text-align: right; margin-top: 1.5rem; display:flex; justify-content:flex-end; gap:0.5rem;">
                    <button class="btn btn-secondary" onclick="resetImportModal()">Back</button>
                    <button class="btn btn-primary" onclick="finalizeImport()">
                        Confirm Import
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let bundleTags = {};
    let ruleTags = {};
    let extraConditions = [];

    function addExtraConditionRow(path = '', op = 'equals', val = '') {
        const container = document.getElementById('extra-conditions-container');
        const div = document.createElement('div');
        div.className = 'form-group extra-condition-row';
        div.style.display = 'grid';
        div.style.gridTemplateColumns = '2fr 1fr 2fr auto';
        div.style.gap = '0.5rem';
        div.style.marginBottom = '0.5rem';
        div.style.alignItems = 'end';

        // Use direct element creation or escape values to prevent HTML injection and breaking attributes
        const pathWrap = document.createElement('div');
        const pathInput = document.createElement('input');
        pathInput.type = 'text';
        pathInput.className = 'form-input ec-path';
        pathInput.placeholder = 'Path';
        pathInput.value = path;
        pathWrap.appendChild(pathInput);

        const opWrap = document.createElement('div');
        const opSelect = document.createElement('select');
        opSelect.className = 'form-input ec-op';
        ['equals', 'exists', 'contains'].forEach(o => {
            const opt = document.createElement('option');
            opt.value = o;
            opt.innerText = o.charAt(0).toUpperCase() + o.slice(1);
            if (o === op) opt.selected = true;
            opSelect.appendChild(opt);
        });
        opWrap.appendChild(opSelect);

        const valWrap = document.createElement('div');
        const valInput = document.createElement('input');
        valInput.type = 'text';
        valInput.className = 'form-input ec-val';
        valInput.placeholder = 'Value';
        valInput.value = val;
        valWrap.appendChild(valInput);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-danger';
        delBtn.style.padding = '0.5rem';
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.onclick = () => div.remove();

        div.appendChild(pathWrap);
        div.appendChild(opWrap);
        div.appendChild(valWrap);
        div.appendChild(delBtn);

        container.appendChild(div);
    }

    function renderTags(prefix) {
        const container = document.getElementById(`${prefix}-tags-container`);
        const tags = prefix === 'b' ? bundleTags : ruleTags;
        container.innerHTML = '';
        for (const [k, v] of Object.entries(tags)) {
            const span = document.createElement('span');
            span.className = 'badge';
            span.style.background = 'var(--bg-primary)';
            span.style.border = '1px solid var(--border-color)';
            span.innerHTML = `${k}=${v} <i class="fas fa-times" onclick="removeTag('${prefix}', '${k}')" style="cursor:pointer; margin-left:0.3rem; opacity:0.6;"></i>`;
            container.appendChild(span);
        }
    }

    function addTag(prefix) {
        const k = document.getElementById(`${prefix}-tag-key`).value.trim();
        const v = document.getElementById(`${prefix}-tag-val`).value.trim();
        if (k && v) {
            if (prefix === 'b') bundleTags[k] = v; else ruleTags[k] = v;
            document.getElementById(`${prefix}-tag-key`).value = '';
            document.getElementById(`${prefix}-tag-val`).value = '';
            renderTags(prefix);
        }
    }
    window.removeTag = function (prefix, k) {
        if (prefix === 'b') delete bundleTags[k]; else delete ruleTags[k];
        renderTags(prefix);
    }
    // --- Multi-Select Logic ---
    function toggleMultiSelect(id) {
        // close others
        document.querySelectorAll('.multi-select-options').forEach(el => {
            if (el.id !== `${id}-options`) el.classList.remove('open');
        });
        const opts = document.getElementById(`${id}-options`);
        opts.classList.toggle('open');
    }

    // Close multi-selects when clicking outside
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.multi-select-container')) {
            document.querySelectorAll('.multi-select-options').forEach(el => el.classList.remove('open'));
        }
    });

    function handleAllSelection(id, allCb) {
        const container = document.getElementById(`${id}-options`);
        const cbs = container.querySelectorAll('input[type="checkbox"]:not([value="All"])');
        cbs.forEach(cb => cb.checked = allCb.checked);
        updateMultiSelectValue(id);
    }

    function updateMultiSelectValue(id) {
        const container = document.getElementById(`${id}-options`);
        const trigger = document.getElementById(`${id}-trigger`);
        const allCb = container.querySelector('input[value="All"]');
        const cbs = Array.from(container.querySelectorAll('input[type="checkbox"]:not([value="All"])'));
        const checked = cbs.filter(cb => cb.checked);

        // Sync "All" checkbox logic
        if (checked.length === cbs.length) {
            allCb.checked = true;
            // trigger.value = "All"; // Optional preference: show "All" or show list?
        } else {
            allCb.checked = false;
        }

        if (checked.length === 0 || checked.length === cbs.length) {
            trigger.value = "All"; // Empty means All
            // If empty, visually check 'All' if not already? Usually better to default to 'All'
            if (checked.length === 0) allCb.checked = true;
        } else {
            trigger.value = checked.map(c => c.value).join(', ');
        }
    }

    function getMultiSelectValue(id) {
        const container = document.getElementById(`${id}-options`);
        const cbs = Array.from(container.querySelectorAll('input[type="checkbox"]:not([value="All"])'));
        const checked = cbs.filter(cb => cb.checked);

        if (checked.length === 0 || checked.length === cbs.length) return null; // All
        return JSON.stringify(checked.map(c => c.value));
    }

    function setMultiSelectValue(id, valStr) {
        const container = document.getElementById(`${id}-options`);
        const allCb = container.querySelector('input[value="All"]');
        const cbs = Array.from(container.querySelectorAll('input[type="checkbox"]:not([value="All"])'));

        // Reset
        cbs.forEach(cb => cb.checked = false);
        allCb.checked = false;

        if (!valStr || valStr === "All") {
            allCb.checked = true;
            cbs.forEach(cb => cb.checked = true);
        } else {
            try {
                // Try parsing as JSON list
                const list = JSON.parse(valStr);
                if (Array.isArray(list)) {
                    list.forEach(v => {
                        const match = cbs.find(cb => cb.value === v);
                        if (match) match.checked = true;
                    });
                } else {
                    // Fallback single string
                    const match = cbs.find(cb => cb.value === valStr);
                    if (match) match.checked = true;
                }
            } catch (e) {
                // Simple string
                const match = cbs.find(cb => cb.value === valStr);
                if (match) match.checked = true;
            }
        }
        updateMultiSelectValue(id);
    }

    // --- Modals ---
    function openBundleModal() {
        document.getElementById('b-id').value = '';
        document.getElementById('b-name').value = '';
        document.getElementById('b-dc').value = '';
        document.getElementById('b-dc').value = '';
        setMultiSelectValue('b-env', null);
        bundleTags = {};
        renderTags('b');
        document.getElementById('b-matches').innerText = '';
        document.getElementById('bundle-modal-title').innerText = "Create Audit Bundle";
        document.getElementById('bundle-modal').classList.add('open');
    }

    function editBundle(id, name, dc, env, tags) {
        document.getElementById('b-id').value = id;
        document.getElementById('b-name').value = name;
        document.getElementById('b-dc').value = dc;
        document.getElementById('b-dc').value = dc;
        setMultiSelectValue('b-env', env);
        bundleTags = tags || {};
        renderTags('b');
        document.getElementById('b-matches').innerText = '';
        document.getElementById('bundle-modal-title').innerText = "Edit Audit Bundle";
        document.getElementById('bundle-modal').classList.add('open');
    }

    function closeBundleModal() {
        document.getElementById('bundle-modal').classList.remove('open');
    }

    function toggleCheckTypeFields() {
        const type = document.getElementById('r-check-type').value;
        const validationGroup = document.getElementById('r-validation-logic-group');
        const existenceGroup = document.getElementById('r-existence-logic-group');
        const resNameContainer = document.getElementById('r-res-name-container');
        const resNameInput = document.getElementById('r-name-match');
        const resNameLabel = resNameContainer.querySelector('.form-label');

        if (type === 'VALIDATION') {
            validationGroup.style.display = 'block';
            existenceGroup.style.display = 'none';
            resNameLabel.innerText = "Resource Name (Optional for Validation)";
            resNameInput.placeholder = "e.g. managed-csi";
        } else {
            validationGroup.style.display = 'none';
            existenceGroup.style.display = 'block';
            resNameLabel.innerText = "Target Resource Name Pattern (Optional)";
            resNameInput.placeholder = "e.g. cluster-admin (case sensitive)";

            // Sync the existence operator to the main r-op
            syncExistenceOp(document.getElementById('r-op-existence'));
        }
    }

    function syncExistenceOp(el) {
        document.getElementById('r-op').value = el.value;
    }

    function openRuleModal(bundleId = null) {
        document.getElementById('r-id').value = '';
        document.getElementById('r-bundle-id').value = bundleId || '';
        document.getElementById('r-name').value = '';
        document.getElementById('r-kind').value = '';
        document.getElementById('r-api').value = '';
        document.getElementById('r-ns').value = '';
        document.getElementById('r-check-type').value = 'VALIDATION';
        document.getElementById('r-path').value = '';
        document.getElementById('r-op').value = 'equals';
        document.getElementById('r-op-existence').value = 'equals';
        document.getElementById('r-val').value = '';
        document.getElementById('r-name-match').value = '';
        document.getElementById('r-matches').innerText = '';
        document.getElementById('r-logic').value = 'AND';
        document.getElementById('r-enabled').checked = true;
        document.getElementById('extra-conditions-container').innerHTML = '';

        toggleCheckTypeFields();

        const scopeSec = document.getElementById('r-scope-section');
        if (bundleId) {
            scopeSec.style.display = 'none';
        } else {
            scopeSec.style.display = 'block';
            document.getElementById('r-dc').value = '';
            document.getElementById('r-dc').value = '';
            setMultiSelectValue('r-env', null);
            ruleTags = {};
            renderTags('r');
        }

        document.getElementById('rule-modal-title').innerText = bundleId ? 'Add Rule to Bundle' : 'Add Ad-hoc Rule';
        document.getElementById('rule-modal').classList.add('open');
    }

    // Event delegation for Edit Rule buttons
    document.addEventListener('click', e => {
        // Rule Edit
        const ruleBtn = e.target.closest('.btn-rule-edit');
        if (ruleBtn) {
            const d = ruleBtn.dataset;
            openRuleModalForEdit(
                d.id, d.name, d.kind, d.api, d.path, d.op, d.val,
                d.dc || null, d.env || null, JSON.parse(d.tags || '{}'),
                d.resName || null, d.ns || null, d.logic || 'AND', d.extras || '[]',
                d.checkType || 'VALIDATION', d.bundleId || null, d.enabled || 'true'
            );
            return;
        }

        // Bundle Edit
        const bundleBtn = e.target.closest('.btn-bundle-edit');
        if (bundleBtn) {
            const d = bundleBtn.dataset;
            editBundle(d.id, d.name, d.dc || null, d.env || null, JSON.parse(d.tags || '{}'));
            return;
        }
    });

    function openRuleModalForEdit(id, name, kind, api, path, op, val, dc, env, tags, resName, ns, logic, extras, checkType, bundleId, ruleBtnEnabled) {
        // Find if this rule has a bundle_id (passed via data attributes in table)
        const isBundled = !!bundleId;

        document.getElementById('r-id').value = id || '';
        document.getElementById('r-bundle-id').value = bundleId || '';
        document.getElementById('r-name').value = name || '';
        document.getElementById('r-kind').value = kind || '';
        document.getElementById('r-api').value = api || '';
        document.getElementById('r-ns').value = ns || '';
        document.getElementById('r-check-type').value = checkType || 'VALIDATION';
        document.getElementById('r-path').value = path || '';
        document.getElementById('r-op').value = op || 'equals';
        document.getElementById('r-op-existence').value = op || 'equals';
        document.getElementById('r-val').value = val || '';
        document.getElementById('r-name-match').value = resName || '';
        document.getElementById('r-logic').value = logic || 'AND';
        document.getElementById('r-enabled').checked = (ruleBtnEnabled === 'true');
        document.getElementById('r-matches').innerText = '';

        toggleCheckTypeFields();

        const container = document.getElementById('extra-conditions-container');
        container.innerHTML = '';
        try {
            const ex = JSON.parse(extras || '[]');
            ex.forEach(c => addExtraConditionRow(c.path, c.op, c.val));
        } catch (e) { }

        const scopeSec = document.getElementById('r-scope-section');
        if (isBundled) {
            scopeSec.style.display = 'none';
        } else {
            scopeSec.style.display = 'block';
            document.getElementById('r-dc').value = dc || '';
            document.getElementById('r-dc').value = dc || '';
            setMultiSelectValue('r-env', env);
            ruleTags = tags || {};
            renderTags('r');
        }

        document.getElementById('rule-modal-title').innerText = 'Edit Rule';
        document.getElementById('rule-modal').classList.add('open');
    }

    function closeRuleModal() {
        document.getElementById('rule-modal').classList.remove('open');
    }

    async function duplicateRule(id) {
        if (!confirm("Duplicate this rule?")) return;
        const res = await fetch(`/api/audit/rules/${id}/duplicate`, { method: 'POST' });
        if (res.ok) window.location.reload();
        else alert("Failed to duplicate rule");
    }

    // --- Export ---
    let exportData = { bundles: [], adhoc: [] };

    function openExportModal() {
        const listDiv = document.getElementById('export-list');
        listDiv.innerHTML = '';

        // Find all bundles and their rules
        const bundleCards = document.querySelectorAll('.bundle-card');
        bundleCards.forEach(card => {
            const bundleName = card.querySelector('.resource-header span').innerText;
            // Get bundle ID from edit button
            const editBtn = card.querySelector('.btn-bundle-edit');
            const bundleId = editBtn ? editBtn.dataset.id : null;

            const bundleDiv = document.createElement('div');
            bundleDiv.style.marginBottom = '1.5rem';
            bundleDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:0.3rem;">
                    <input type="checkbox" class="export-bundle-cb" data-id="${bundleId}" onchange="toggleBundleRules(this)">
                    <strong style="color:var(--accent-color);"><i class="fas fa-box"></i> ${bundleName}</strong>
                </div>
                <div class="bundle-rules-list" style="padding-left:1.5rem; display:flex; flex-direction:column; gap:0.3rem;">
                </div>
            `;

            const ruleRows = card.querySelectorAll('tbody tr');
            const ruleList = bundleDiv.querySelector('.bundle-rules-list');
            ruleRows.forEach(row => {
                const ruleName = row.cells[0].innerText;
                const editBtn = row.querySelector('.btn-rule-edit');
                const ruleId = editBtn ? editBtn.dataset.id : null;

                if (ruleId) {
                    const ruleDiv = document.createElement('div');
                    ruleDiv.innerHTML = `
                        <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                            <input type="checkbox" class="export-rule-cb" data-id="${ruleId}" data-bundle-id="${bundleId}">
                            <span>${ruleName}</span>
                        </label>
                    `;
                    ruleList.appendChild(ruleDiv);
                }
            });
            listDiv.appendChild(bundleDiv);
        });

        // Ad-hoc
        const adhocTable = document.querySelector('div.card:not(.bundle-card) table');
        if (adhocTable) {
            const adhocDiv = document.createElement('div');
            adhocDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:0.3rem;">
                    <strong><i class="fas fa-list"></i> Ad-hoc Rules</strong>
                </div>
                <div class="adhoc-rules-list" style="padding-left:1.5rem; display:flex; flex-direction:column; gap:0.3rem;">
                </div>
            `;
            const rows = adhocTable.querySelectorAll('tbody tr');
            const list = adhocDiv.querySelector('.adhoc-rules-list');
            rows.forEach(row => {
                const ruleName = row.cells[0].innerText;
                if (ruleName === "No ad-hoc rules.") return;
                const editBtn = row.querySelector('.btn-rule-edit');
                const ruleId = editBtn ? editBtn.dataset.id : null;

                if (ruleId) {
                    const itemDiv = document.createElement('div');
                    itemDiv.innerHTML = `
                        <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                            <input type="checkbox" class="export-rule-cb" data-id="${ruleId}">
                            <span>${ruleName}</span>
                        </label>
                    `;
                    list.appendChild(itemDiv);
                }
            });
            listDiv.appendChild(adhocDiv);
        }

        document.getElementById('export-modal').classList.add('open');
    }

    function toggleBundleRules(cb) {
        const bundleId = cb.dataset.id;
        const rules = document.querySelectorAll(`.export-rule-cb[data-bundle-id="${bundleId}"]`);
        rules.forEach(r => r.checked = cb.checked);
    }

    function exportSelectAll(val) {
        document.querySelectorAll('.export-bundle-cb, .export-rule-cb').forEach(c => c.checked = val);
    }

    function closeExportModal() {
        document.getElementById('export-modal').classList.remove('open');
    }

    async function downloadExport() {
        const bundleIds = Array.from(document.querySelectorAll('.export-bundle-cb:checked')).map(c => parseInt(c.dataset.id));
        const ruleIds = Array.from(document.querySelectorAll('.export-rule-cb:checked')).map(c => parseInt(c.dataset.id));

        if (bundleIds.length === 0 && ruleIds.length === 0) return alert("Select at least one item");

        const res = await fetch('/api/audit/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bundle_ids: bundleIds, rule_ids: ruleIds })
        });

        if (res.ok) {
            const data = await res.json();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit_rules_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            closeExportModal();
        } else {
            alert("Export failed");
        }
    }

    // --- Import ---
    let pendingImport = null;

    function openImportModal() {
        resetImportModal();
        document.getElementById('import-modal').classList.add('open');
    }

    function closeImportModal() {
        document.getElementById('import-modal').classList.remove('open');
    }

    function resetImportModal() {
        document.getElementById('import-upload-section').style.display = 'block';
        document.getElementById('import-preview-section').style.display = 'none';
        document.getElementById('import-file-input').value = '';
        pendingImport = null;
    }

    async function handleImportFile(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                const res = await fetch('/api/audit/import/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    pendingImport = await res.json();
                    renderImportPreview();
                } else {
                    alert("Invalid export file");
                }
            } catch (err) {
                alert("Error parsing JSON file");
            }
        };
        reader.readAsText(file);
    }

    function renderImportPreview() {
        document.getElementById('import-upload-section').style.display = 'none';
        document.getElementById('import-preview-section').style.display = 'block';

        const container = document.getElementById('import-preview-table-container');
        let html = `
            <table class="data-table" style="font-size:0.9rem;">
                <thead>
                    <tr>
                        <th style="width:50px;">Import</th>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
        `;

        pendingImport.bundles.forEach((b, idx) => {
            html += `
                <tr class="import-row" data-type="bundle" data-idx="${idx}">
                    <td style="text-align:center;"><input type="checkbox" checked class="import-cb"></td>
                    <td><span class="badge badge-purple">Bundle</span></td>
                    <td>${b.name}</td>
                    <td>${b.status === 'CONFLICT' ? '<span class="badge badge-orange">Conflict (Exists)</span>' : '<span class="badge badge-green">New</span>'}</td>
                    <td>
                        <select class="form-input import-action" style="padding:0.2rem; font-size:0.8rem;">
                            ${b.status === 'CONFLICT' ? '<option value="OVERWRITE">Overwrite</option><option value="SKIP">Skip</option>' : '<option value="CREATE">Create</option>'}
                        </select>
                    </td>
                </tr>
            `;
        });

        pendingImport.rules.forEach((r, idx) => {
            html += `
                <tr class="import-row" data-type="rule" data-idx="${idx}">
                    <td style="text-align:center;"><input type="checkbox" checked class="import-cb"></td>
                    <td><span class="badge badge-blue">Rule</span></td>
                    <td>${r.name}</td>
                    <td>${r.status === 'CONFLICT' ? '<span class="badge badge-orange">Conflict (Exists)</span>' : '<span class="badge badge-green">New</span>'}</td>
                    <td>
                        <select class="form-input import-action" style="padding:0.2rem; font-size:0.8rem;">
                            ${r.status === 'CONFLICT' ? '<option value="OVERWRITE">Overwrite</option><option value="SKIP">Skip</option>' : '<option value="CREATE">Create</option>'}
                        </select>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    async function finalizeImport() {
        const rows = document.querySelectorAll('.import-row');
        const req = { bundles: [], rules: [] };

        rows.forEach(row => {
            const cb = row.querySelector('.import-cb');
            if (!cb.checked) return;

            const type = row.dataset.type;
            const idx = parseInt(row.dataset.idx);
            const action = row.querySelector('.import-action').value;
            const item = type === 'bundle' ? pendingImport.bundles[idx] : pendingImport.rules[idx];

            const rowData = {
                name: item.name,
                action: action,
                existing_id: item.existing_id,
                data: item.data
            };

            if (type === 'bundle') req.bundles.push(rowData);
            else req.rules.push(rowData);
        });

        if (req.bundles.length === 0 && req.rules.length === 0) return alert("Nothing selected to import");

        const res = await fetch('/api/audit/import/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(req)
        });

        if (res.ok) {
            window.location.reload();
        } else {
            alert("Import failed");
        }
    }

    function checkScopeMatch(scopeVal, clusterVal) {
        if (!scopeVal || scopeVal === "All") return true;
        if (scopeVal === clusterVal) return true;
        try {
            const list = JSON.parse(scopeVal);
            if (Array.isArray(list)) return list.includes(clusterVal);
        } catch (e) { }
        return false;
    }

    // --- API ---
    async function showMatches(prefix) {
        const tags = prefix === 'b' ? bundleTags : ruleTags;
        const dc = document.getElementById(`${prefix}-dc`).value;
        const env = getMultiSelectValue(`${prefix}-env`);

        const container = document.getElementById(`${prefix}-matches`);
        container.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Checking...';

        const res = await fetch('/api/audit/match_clusters', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tags: JSON.stringify(tags),
                match_datacenter: dc || null,
                match_environment: env || null
            })
        });
        const matches = await res.json();

        if (matches.length > 0) {
            container.innerHTML = `<span style="color:var(--success-color);">Matches ${matches.length} cluster(s):</span> ` + matches.map(c => `<b>${c.name}</b>`).join(', ');
        } else {
            container.innerHTML = '<span style="color:var(--warning-color);">No matching clusters found (Tags mismatch).</span>';
        }
    }

    async function submitBundle() {
        const id = document.getElementById('b-id').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/audit/bundles/${id}` : '/api/audit/bundles';

        const data = {
            name: document.getElementById('b-name').value,
            match_datacenter: document.getElementById('b-dc').value || null,
            match_environment: getMultiSelectValue('b-env'),
            tags: JSON.stringify(bundleTags)
        };
        if (!data.name) return alert("Name required");

        await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        window.location.reload();
    }

    async function deleteBundle(id) {
        if (!confirm("Delete bundle and ALL its rules?")) return;
        await fetch(`/api/audit/bundles/${id}`, { method: 'DELETE' });
        window.location.reload();
    }

    async function deleteRule(id) {
        if (!confirm("Delete rule?")) return;
        await fetch(`/api/audit/rules/${id}`, { method: 'DELETE' });
        window.location.reload();
    }

    async function submitRule() {
        const id = document.getElementById('r-id').value;
        const bundleId = document.getElementById('r-bundle-id').value;

        // Collect extras
        const extrasRows = document.querySelectorAll('.extra-condition-row');
        const extras = [];
        extrasRows.forEach(row => {
            extras.push({
                path: row.querySelector('.ec-path').value,
                op: row.querySelector('.ec-op').value,
                val: row.querySelector('.ec-val').value
            });
        });

        const data = {
            name: document.getElementById('r-name').value,
            resource_kind: document.getElementById('r-kind').value,
            api_version: document.getElementById('r-api').value,
            namespace: document.getElementById('r-ns').value || null,
            check_type: document.getElementById('r-check-type').value,
            field_path: document.getElementById('r-path').value,
            operator: document.getElementById('r-op').value,
            expected_value: document.getElementById('r-val').value || null,
            bundle_id: bundleId ? parseInt(bundleId) : null,
            match_datacenter: document.getElementById('r-dc').value || null,
            match_environment: getMultiSelectValue('r-env'),
            match_resource_name: document.getElementById('r-name-match').value || null,
            condition_logic: document.getElementById('r-logic').value,
            extra_conditions: JSON.stringify(extras),
            tags: JSON.stringify(ruleTags),
            is_enabled: document.getElementById('r-enabled').checked
        };

        if (!data.name || !data.resource_kind) {
            alert("Name and Resource Kind are required.");
            return;
        }
        if (data.check_type === 'VALIDATION' && !data.field_path) {
            alert("Field Path is required for Field Validation rules.");
            return;
        }
        if ((data.check_type === 'EXISTENCE' || data.check_type === 'FORBIDDANCE') && !data.match_resource_name && !data.field_path && extras.length === 0) {
            alert("Please provide either a Target Resource Name or at least one Advanced Condition.");
            return;
        }

        let url = '/api/audit/rules';
        let method = 'POST';

        if (id) {
            url = `/api/audit/rules/${id}`;
            method = 'PUT';
        }

        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            // Save state of open bundles before reload
            const openBundles = Array.from(document.querySelectorAll('.bundle-card.open')).map(c => c.id);
            localStorage.setItem('openAuditBundles', JSON.stringify(openBundles));
            window.location.reload();
        } else {
            const err = await res.json();
            alert("Error: " + (err.detail || "Failed to save rule"));
        }
    }

    async function toggleRuleStatus(ruleId) {
        const res = await fetch(`/api/audit/rules/${ruleId}/toggle`, { method: 'POST' });
        if (res.ok) {
            // Save state of open bundles before reload
            const openBundles = Array.from(document.querySelectorAll('.bundle-card.open')).map(c => c.id);
            localStorage.setItem('openAuditBundles', JSON.stringify(openBundles));
            window.location.reload();
        } else {
            const err = await res.json();
            alert("Error toggling status: " + (err.detail || "Unknown error"));
        }
    }

    // --- Bundle Toggle ---
    function filterRules() {
        const query = document.getElementById('rule-search').value.toLowerCase().trim();
        const bundles = document.querySelectorAll('.bundle-card');
        const adHocCard = document.querySelector('div.card.fade-in[style*="margin-top: 2rem"]'); // Ad-hoc rules card
        const adHocRows = adHocCard ? adHocCard.querySelectorAll('tbody tr') : [];
        let visibleBundles = 0;
        let visibleAdHocRows = 0;

        // 1. Filter Bundles
        bundles.forEach(bundle => {
            const bundleName = (bundle.querySelector('.bundle-header span')?.innerText || "").toLowerCase();
            const bundleTags = Array.from(bundle.querySelectorAll('.bundle-header .badge')).map(b => b.innerText.toLowerCase()).join(' ');
            const ruleRows = bundle.querySelectorAll('tbody tr');
            let bundleHasMatchingRule = false;

            ruleRows.forEach(row => {
                // Skip the "No rules in this bundle" placeholder
                const isPlaceholder = row.cells.length === 1 && row.innerText.toLowerCase().includes('no rules');
                if (isPlaceholder) {
                    row.style.display = (query === '') ? '' : 'none';
                    return;
                }

                const ruleName = (row.querySelector('td:first-child')?.innerText || "").toLowerCase();
                const ruleContent = (row.innerText || "").toLowerCase();
                const matches = !query || ruleName.includes(query) || ruleContent.includes(query);
                row.style.display = matches ? '' : 'none';
                if (matches) bundleHasMatchingRule = true;
            });

            const bundleMatches = !query || bundleName.includes(query) || bundleTags.includes(query) || bundleHasMatchingRule;

            if (bundleMatches) {
                bundle.style.display = '';
                visibleBundles++;
            } else {
                bundle.style.display = 'none';
            }
        });

        // 2. Filter Ad-hoc Rules
        if (adHocRows.length > 0) {
            adHocRows.forEach(row => {
                const isPlaceholder = row.cells.length === 1 && row.innerText.toLowerCase().includes('no ad-hoc rules');
                if (isPlaceholder) {
                    row.style.display = (query === '') ? '' : 'none';
                    return;
                }

                // Legitimate ad-hoc rules have at least 5 columns
                if (row.cells.length < 5) return;

                const ruleName = (row.querySelector('td:first-child')?.innerText || "").toLowerCase();
                const ruleContent = (row.innerText || "").toLowerCase();
                const matches = !query || ruleName.includes(query) || ruleContent.includes(query);
                row.style.display = matches ? '' : 'none';
                if (matches) visibleAdHocRows++;
            });

            // Hide the ad-hoc card if no rules match and there's a query
            if (query && visibleAdHocRows === 0) {
                adHocCard.style.display = 'none';
            } else {
                adHocCard.style.display = '';
            }
        }

        // 3. Global "No results" message
        const noBundlesMsg = document.getElementById('no-bundles-message');
        if (noBundlesMsg) {
            noBundlesMsg.style.display = (query && visibleBundles === 0 && visibleAdHocRows === 0) ? 'block' : 'none';
        }
    }

    function toggleBundle(cardId) {
        const card = document.getElementById(cardId);
        if (card) {
            card.classList.toggle('open');

            // Persist state
            const openBundles = Array.from(document.querySelectorAll('.bundle-card.open')).map(c => c.id);
            localStorage.setItem('openAuditBundles', JSON.stringify(openBundles));
        }
    }



    // Restore state on load
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const openBundles = JSON.parse(localStorage.getItem('openAuditBundles') || "[]");
            openBundles.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('open');
            });
        } catch (e) {
            console.error("Failed to restore bundle state", e);
        }
    });

</script>
{% endblock %}