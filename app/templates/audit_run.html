{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
<div class="page-header">
    <div>
        <h1 class="page-title">Compliance Execution</h1>
        <p style="opacity:0.6; font-size:0.9rem; margin-top:0.2rem;">Monitor and manage cluster compliance status across
            your fleet.</p>
    </div>
    <div style="display:flex; gap:0.5rem; align-items:center;">
        <div style="display:flex; gap:0.3rem; margin-right:1rem;">
            <button class="btn btn-secondary" style="padding:0.4rem 0.8rem;"
                onclick="exportTable('Compliance_Summary', 'excel')">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn btn-secondary" style="padding:0.4rem 0.8rem;"
                onclick="exportTable('Compliance_Summary', 'csv')">
                <i class="fas fa-file-csv"></i> CSV
            </button>
        </div>
        <button class="btn btn-primary" onclick="openMassAuditModal()">
            <i class="fas fa-layer-group" style="margin-right:0.5rem;"></i> Mass Audit Dispatcher
        </button>
    </div>
</div>

<!-- Cluster Table -->
<div class="card fade-in">
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Cluster Name</th>
                    <th>Environment</th>
                    <th>Tags</th>
                    <th>Last Compliance</th>
                    <th>Targeted Content</th>
                    <th style="width:150px;">Actions</th>
                </tr>
            </thead>
            <tbody id="cluster-table-body">
                <tr>
                    <td colspan="5" style="text-align:center; padding:2rem;"><i class="fas fa-circle-notch fa-spin"></i>
                        Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Audit Modal -->
<div id="audit-modal" class="modal">
    <div class="modal-content"
        style="width:800px; max-width:95vh; max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal-header">
            <h3 id="modal-title">Audit Results</h3>
            <div style="display:flex; gap:0.5rem; margin-left:auto; margin-right:1rem;">
                <button class="btn btn-secondary btn-sm" onclick="exportTable('Audit_Results', 'excel')">
                    <i class="fas fa-file-excel"></i>
                </button>
                <button class="btn btn-secondary btn-sm" onclick="exportTable('Audit_Results', 'csv')">
                    <i class="fas fa-file-csv"></i>
                </button>
            </div>
            <button onclick="closeModal()" class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" id="modal-body" style="overflow-y:auto; flex:1;">
            <!-- Results injected here -->
        </div>
        <div id="audit-modal-footer"
            style="padding:1rem; border-top:1px solid var(--border-color); text-align:right; display:flex; justify-content:flex-end; gap:0.5rem;">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<!-- Mass Audit Dispatcher Modal -->
<div id="mass-audit-modal" class="modal">
    <div class="modal-content" style="width:700px; max-width:95vw; background:var(--bg-secondary);">
        <div class="modal-header">
            <h3>Mass Audit Dispatcher</h3>
            <button onclick="closeMassAuditModal()" class="close-btn">&times;</button>
        </div>

        <!-- Step 1: Select Targets -->
        <div id="mass-step-1" class="mass-step">
            <div style="padding:1.5rem;">
                <h4 style="margin-bottom:1rem;">1. Select Targeting Criteria</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:1.5rem;">
                    <div class="filter-card" onclick="setMassMode('custom')" id="mode-custom">
                        <i class="fas fa-list-check fa-2x"></i>
                        <strong>Custom Selection</strong>
                        <span>Select individual bundles and rules</span>
                    </div>
                    <div class="filter-card" onclick="setMassMode('all')" id="mode-all">
                        <i class="fas fa-play-circle fa-2x"></i>
                        <strong>Run All</strong>
                        <span>Run all assigned bundles/rules against all clusters</span>
                    </div>
                </div>

                <div id="custom-filter" style="display:none;">
                    <div
                        style="margin-bottom:1rem; border:1px solid var(--border-color); border-radius:8px; background:rgba(0,0,0,0.1); overflow:hidden;">
                        <div
                            style="padding:0.8rem; background:rgba(255,255,255,0.03); border-bottom:1px solid var(--border-color); font-weight:600; display:flex; justify-content:space-between; align-items:center;">
                            <span>Rules & Bundles</span>
                            <div style="font-size:0.8rem; display:flex; gap:0.5rem;">
                                <button class="btn btn-secondary" style="padding:0.2rem 0.5rem;"
                                    onclick="selectAllCustom(true)">All</button>
                                <button class="btn btn-secondary" style="padding:0.2rem 0.5rem;"
                                    onclick="selectAllCustom(false)">None</button>
                            </div>
                        </div>
                        <div id="custom-selection-list" style="max-height:250px; overflow-y:auto; padding:0.5rem;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div id="bundle-filter" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Select Audit Bundle</label>
                        <select id="mass-bundle-id" class="form-input"></select>
                    </div>
                </div>

                <div style="margin-top:2rem; text-align:right;">
                    <button class="btn btn-primary" id="mass-next-btn" onclick="calculateMassTargets()">
                        Next: Preview Targets <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="btn btn-primary" id="mass-launch-btn" onclick="calculateMassTargets()"
                        style="display:none;">
                        Launch Audit <i class="fas fa-rocket"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Preview Targets -->
        <div id="mass-step-2" class="mass-step" style="display:none;">
            <div style="padding:1.5rem;">
                <h4 style="margin-bottom:1rem;">2. Confirm Target Clusters</h4>
                <div id="target-summary"
                    style="margin-bottom:1rem; padding:0.8rem; background:rgba(0,0,0,0.1); border-radius:6px; font-weight:600;">
                </div>
                <div id="target-list"
                    style="max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:6px; margin-bottom:1.5rem;">
                    <!-- Targeted clusters with checkboxes -->
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <button class="btn btn-secondary" onclick="showMassStep(1)">Back</button>
                    <button class="btn btn-primary" onclick="launchMassAudit()">
                        Launch Mass Audit <i class="fas fa-rocket"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Execution -->
        <div id="mass-step-3" class="mass-step" style="display:none;">
            <div style="padding:1.5rem; text-align:center;">
                <h4 style="margin-bottom:1.5rem;">3. Executing Bulk Scan</h4>
                <div id="mass-progress-text" style="margin-bottom:0.5rem; font-size:0.9rem;">Initializing...</div>
                <div class="progress-bar-container"
                    style="height:12px; background:var(--bg-primary); border-radius:10px; overflow:hidden; margin-bottom:1.5rem;">
                    <div id="mass-progress-fill"
                        style="height:100%; width:0%; background:var(--accent-color); transition: width 0.3s ease;">
                    </div>
                </div>
                <div id="mass-log"
                    style="text-align:left; max-height:200px; overflow-y:auto; font-family:monospace; font-size:0.8rem; background:#000; padding:1rem; border-radius:6px; opacity:0.8;">
                    <!-- Progress logs -->
                </div>
                <div id="mass-done" style="display:none; margin-top:1.5rem;">
                    <button class="btn btn-primary" onclick="window.location.reload()">Finish & Refresh</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Snapshot Modal -->
<div id="snapshot-modal" class="modal">
    <div class="modal-content" style="width:900px; max-width:95vw; background:var(--bg-secondary);">
        <div class="modal-header">
            <h3 id="snapshot-title">Resource Snapshot</h3>
            <button onclick="closeSnapshotModal()" class="close-btn">&times;</button>
        </div>
        <div class="modal-body"
            style="background:#0D1117; padding:1.5rem; overflow-x:auto; min-height: 200px; max-height: 70vh;">
            <pre id="snapshot-content"
                style="margin:0; font-family:'Fira Code', 'Courier New', monospace; font-size:0.85rem; color:#E6EDF3; line-height:1.5; tab-size:2;"></pre>
        </div>
        <div id="snapshot-modal-footer"
            style="padding:1rem; border-top:1px solid var(--border-color); text-align:right;">
            <button class="btn btn-secondary" onclick="closeSnapshotModal()">Close</button>
        </div>
    </div>
</div>

<style>
    .filter-card {
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: all 0.2s ease;
    }

    .filter-card:hover {
        border-color: var(--accent-color);
        transform: translateY(-3px);
    }

    .filter-card.active {
        border-color: var(--accent-color);
        background: rgba(58, 134, 255, 0.05);
    }

    .filter-card i {
        color: var(--accent-color);
        margin-bottom: 0.8rem;
    }

    .filter-card span {
        font-size: 0.8rem;
        opacity: 0.6;
        margin-top: 0.3rem;
    }

    .mass-step {
        animation: fadeIn 0.3s ease;
    }

    .target-item {
        padding: 0.8rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .target-item:last-child {
        border-bottom: none;
    }

    /* Compliance Progress Ring */
    .compliance-ring-container {
        position: relative;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .compliance-ring-svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
    }

    .compliance-ring-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.05);
        stroke-width: 4;
    }

    .compliance-ring-fill {
        fill: none;
        stroke-width: 4;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
    }

    .clickable-result {
        cursor: pointer;
        transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .clickable-result:hover {
        transform: translateY(-2px);
        border-color: var(--accent-color) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
</style>

<script>
    let ruleBundles = [];
    let adhocRules = [];
    let allClusters = [];

    async function loadData() {
        const [clusters, bundles, rules, scores] = await Promise.all([
            fetch('/api/admin/clusters/').then(r => r.json()),
            fetch('/api/audit/bundles').then(r => r.json()),
            fetch('/api/audit/rules').then(r => r.json()),
            fetch('/api/audit/compliance/latest').then(r => r.json())
        ]);
        ruleBundles = bundles;
        adhocRules = rules;
        allClusters = clusters;
        renderClusters(clusters, scores);
    }

    function checkScopeMatch(scopeVal, clusterVal) {
        if (!scopeVal || scopeVal === "All") return true;
        if (scopeVal === clusterVal) return true;
        try {
            const list = JSON.parse(scopeVal);
            if (Array.isArray(list)) return list.includes(clusterVal);
        } catch (e) { }
        return false;
    }

    function parseTags(jsonStr) {
        try { return JSON.parse(jsonStr || '{}'); } catch (e) { return {}; }
    }

    function tagsMatch(targetTags, clusterTags) {
        if (!targetTags || Object.keys(targetTags).length === 0) return true;
        for (const k in targetTags) {
            if (clusterTags[k] !== targetTags[k]) return false;
        }
        return true;
    }

    function renderClusters(clusters, scores = []) {
        const tbody = document.getElementById('cluster-table-body');
        if (clusters.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem;">No clusters found.</td></tr>';
            return;
        }

        tbody.innerHTML = clusters.map(c => {
            const cTags = parseTags(c.tags);
            const score = scores.find(s => s.cluster_id === c.id);

            // Find matching bundles
            const matches = ruleBundles.filter(b => {
                if (b.match_datacenter && b.match_datacenter !== c.datacenter) return false;
                if (!checkScopeMatch(b.match_environment, c.environment)) return false;
                const bTags = parseTags(b.tags);
                return tagsMatch(bTags, cTags);
            });

            // Count Ad-hoc
            const adhocMatches = adhocRules.filter(r => {
                if (r.bundle_id) return false;
                if (r.match_datacenter && r.match_datacenter !== c.datacenter) return false;
                if (!checkScopeMatch(r.match_environment, c.environment)) return false;
                return tagsMatch(parseTags(r.tags), cTags);
            });

            const tagsHtml = Object.entries(cTags).map(([k, v]) =>
                `<span class="badge" style="background:var(--bg-primary); border:1px solid var(--border-color); font-size:0.7rem;">${k}=${v}</span>`
            ).join(' ');

            let detailsHtml = '';
            if (score && score.results_json) {
                try {
                    const results = JSON.parse(score.results_json);
                    const map = {};
                    results.forEach(r => {
                        const bName = r.bundle_name || 'Ad-hoc Rules';
                        if (!map[bName]) map[bName] = [];
                        map[bName].push(r);
                    });

                    detailsHtml = '<div style="padding:1rem; background:rgba(0,0,0,0.2); border-radius:8px; margin:0.5rem 0;">';
                    detailsHtml += '<h4 style="margin-bottom:1rem; font-size:0.9rem; opacity:0.8;">Last Scan Result Details</h4>';

                    for (const [bundleName, items] of Object.entries(map)) {
                        detailsHtml += `<div style="margin-bottom:0.5rem; font-weight:600; font-size:0.85rem; color:var(--accent-color);">${bundleName}</div>`;
                        detailsHtml += '<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:0.5rem; margin-bottom:1rem;">';
                        items.forEach((i, idx) => {
                            const color = i.status === 'PASS' ? 'var(--success-color)' : (i.status === 'FAIL' ? 'var(--danger-color)' : 'var(--warning-color)');
                            const hasSnapshots = i.failed_resources && i.failed_resources.length > 0;

                            // Create a stable reference for the snapshot data
                            const snapshotKey = `snapshot_${c.id}_${bundleName.replace(/\s/g, '_')}_${idx}`;
                            if (hasSnapshots) {
                                window[snapshotKey] = i.failed_resources;
                            }

                            detailsHtml += `
                                <div class="${hasSnapshots ? 'clickable-result' : ''}" 
                                     ${hasSnapshots ? `onclick="viewSnapshots('${i.rule_name}', '${snapshotKey}')"` : ''}
                                     style="background:var(--bg-secondary); border:1px solid var(--border-color); padding:0.6rem; border-radius:6px; display:flex; flex-direction:column; gap:0.4rem; min-height:80px;">
                                    <div style="display:flex; justify-content:space-between; align-items:start;">
                                        <div style="font-size:0.85rem;">
                                            <div style="font-weight:600;">${i.rule_name}</div>
                                            <div style="font-size:0.7rem; opacity:0.6;">${i.resource_kind}</div>
                                        </div>
                                        <span class="badge" style="background:${color}20; color:${color}; border:1px solid ${color}; font-size:0.7rem; padding:0.1rem 0.4rem;">${i.status}</span>
                                    </div>
                                    ${i.status !== 'PASS' ? `
                                        <div style="font-size:0.75rem; color:var(--danger-color); opacity:0.9; line-height:1.2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">
                                            ${i.detail}
                                        </div>
                                    ` : ''}
                                    ${hasSnapshots ? `
                                        <div style="margin-top:auto; font-size:0.65rem; color:var(--accent-color); font-weight:600; text-transform:uppercase;">
                                            <i class="fas fa-eye"></i> View Snapshot (${i.failed_resources.length})
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        detailsHtml += '</div>';
                    }
                    detailsHtml += '</div>';
                } catch (e) {
                    detailsHtml = '<div style="padding:1rem; opacity:0.5; font-style:italic;">Detailed results unavailable for this scan version.</div>';
                }
            } else if (score) {
                detailsHtml = '<div style="padding:1rem; opacity:0.5; font-style:italic;">No detailed results available for this record.</div>';
            } else {
                detailsHtml = '<div style="padding:1rem; opacity:0.5; font-style:italic;">No historical scan data found.</div>';
            }

            return `
            <tr id="row-${c.id}">
                <td>
                    <div style="display:flex; align-items:center; gap:0.8rem;">
                        <button class="btn-icon" onclick="toggleDetails(${c.id})" id="toggle-${c.id}">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div style="font-weight:600; color:var(--accent-color);">${c.name}</div>
                    </div>
                </td>
                <td>
                    <span class="badge badge-blue">${c.datacenter || 'N/A'}</span>
                    <span class="badge badge-green">${c.environment || 'N/A'}</span>
                </td>
                <td>
                    <div style="display:flex; flex-wrap:wrap; gap:0.3rem;">
                        ${tagsHtml || '<span style="opacity:0.5; font-size:0.8rem;">No tags</span>'}
                    </div>
                </td>
                <td>
                    ${score ? (() => {
                    const radius = 18;
                    const circumference = 2 * Math.PI * radius;
                    const offset = circumference - (score.score / 100) * circumference;
                    const color = score.score >= 100 ? 'var(--success-color)' : (score.score >= 80 ? 'var(--warning-color)' : 'var(--danger-color)');

                    return `
                        <div style="display:flex; align-items:center; gap:0.8rem;">
                            <div class="compliance-ring-container">
                                <svg class="compliance-ring-svg" viewBox="0 0 44 44">
                                    <circle class="compliance-ring-bg" cx="22" cy="22" r="${radius}"></circle>
                                    <circle class="compliance-ring-fill" cx="22" cy="22" r="${radius}"
                                            style="stroke:${color}; stroke-dasharray:${circumference}; stroke-dashoffset:${offset};">
                                    </circle>
                                </svg>
                            </div>
                            <div>
                                <div style="font-weight:100; color:${color}; font-size:1.1rem; line-height:1;">
                                    ${score.score}%
                                </div>
                                <div style="font-size:0.7rem; opacity:0.6; margin-top:0.2rem;">
                                    ${score.passed_count}/${score.total_count} Passed<br>
                                    ${score.timestamp}
                                </div>
                            </div>
                        </div>
                        `;
                })() : '<span style="opacity:0.4; font-style:italic;">No data</span>'}
                </td>
                <td>
                    <div style="font-size:0.9rem;">
                        <strong>${matches.length}</strong> Bundle(s), <strong>${adhocMatches.length}</strong> Rule(s)
                    </div>
                </td>
                <td>
                    <button class="btn btn-primary" style="padding:0.4rem 0.8rem; font-size:0.85rem;" onclick="openAuditModal(${c.id}, '${c.name}')">
                        <i class="fas fa-play"></i> Run Audit
                    </button>
                </td>
            </tr>
            <tr id="details-${c.id}" style="display:none; background:rgba(255,255,255,0.01);">
                <td colspan="6" style="padding:0 1.5rem 1rem 1.5rem; border-top:none;">
                    ${detailsHtml}
                </td>
            </tr>
            `;
        }).join('');
    }

    function toggleDetails(clusterId) {
        const detailsRow = document.getElementById(`details-${clusterId}`);
        const toggleBtn = document.getElementById(`toggle-${clusterId}`);
        const isHidden = detailsRow.style.display === 'none';

        detailsRow.style.display = isHidden ? 'table-row' : 'none';
        toggleBtn.querySelector('i').className = isHidden ? 'fas fa-chevron-down' : 'fas fa-chevron-right';

        if (isHidden) {
            toggleBtn.style.color = 'var(--accent-color)';
        } else {
            toggleBtn.style.color = 'inherit';
        }
    }

    function openAuditModal(clusterId, clusterName) {
        const cluster = allClusters.find(c => c.id === clusterId);
        if (!cluster) return;

        const cTags = parseTags(cluster.tags);
        const matchedBundles = ruleBundles.filter(b => {
            if (b.match_datacenter && b.match_datacenter !== cluster.datacenter) return false;
            if (!checkScopeMatch(b.match_environment, cluster.environment)) return false;
            return tagsMatch(parseTags(b.tags), cTags);
        });

        const matchedAdhoc = adhocRules.filter(r => {
            if (r.bundle_id) return false;
            if (r.match_datacenter && r.match_datacenter !== cluster.datacenter) return false;
            if (!checkScopeMatch(r.match_environment, cluster.environment)) return false;
            return tagsMatch(parseTags(r.tags), cTags);
        });

        document.getElementById('modal-title').innerText = `Confirm Audit Execution`;
        const body = document.getElementById('modal-body');
        const footer = document.getElementById('audit-modal-footer');

        let html = `
            <div style="padding:1rem;">
                <div style="margin-bottom:1.5rem; border-left:4px solid var(--accent-color); padding-left:1rem;">
                    <h4 style="margin:0 0 0.5rem 0;">Target Cluster</h4>
                    <div style="font-size:1.1rem; font-weight:700;">${clusterName}</div>
                    <div style="font-size:0.85rem; opacity:0.6;">DC: ${cluster.datacenter || 'N/A'} | Env: ${cluster.environment || 'N/A'}</div>
                </div>

                <p style="margin-bottom:1rem; opacity:0.8;">The following rules and bundles match this cluster and will be executed:</p>
                
                <div style="display:flex; flex-direction:column; gap:0.5rem;">
        `;

        matchedBundles.forEach(b => {
            const rules = adhocRules.filter(r => r.bundle_id === b.id);
            html += `
                <div style="background:rgba(58,134,255,0.05); border:1px solid rgba(58,134,255,0.2); padding:0.8rem; border-radius:6px;">
                    <div style="font-weight:600; color:var(--accent-color); display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                        <span><i class="fas fa-box"></i> ${b.name}</span>
                        <span style="font-size:0.8rem; opacity:0.6;">${rules.length} Rules</span>
                    </div>
                    <div style="padding-left:1.5rem; display:flex; flex-direction:column; gap:0.2rem; border-left:1px solid rgba(58,134,255,0.2);">
                        ${rules.map(r => `<div style="font-size:0.85rem; opacity:0.8;"><i class="fas fa-caret-right" style="font-size:0.7rem; margin-right:0.4rem; opacity:0.5;"></i>${r.name}</div>`).join('')}
                    </div>
                </div>
            `;
        });

        if (matchedAdhoc.length > 0) {
            html += `
                <div style="background:rgba(255,255,255,0.03); border:1px solid var(--border-color); padding:0.8rem; border-radius:6px;">
                    <div style="font-weight:600; display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                        <span><i class="fas fa-list"></i> Ad-hoc Rules</span>
                        <span style="font-size:0.8rem; opacity:0.6;">${matchedAdhoc.length} Rules</span>
                    </div>
                    <div style="padding-left:1.5rem; display:flex; flex-direction:column; gap:0.2rem; border-left:1px solid var(--border-color);">
                        ${matchedAdhoc.map(r => `<div style="font-size:0.85rem; opacity:0.8;"><i class="fas fa-caret-right" style="font-size:0.7rem; margin-right:0.4rem; opacity:0.5;"></i>${r.name}</div>`).join('')}
                    </div>
                </div>
            `;
        }

        if (matchedBundles.length === 0 && matchedAdhoc.length === 0) {
            html += `<div class="card" style="text-align:center; color:var(--danger-color); border-color:var(--danger-color);">No matching rules found for this cluster context.</div>`;
        }

        html += `</div></div>`;
        body.innerHTML = html;

        footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="runAudit(${clusterId}, '${clusterName}')" ${matchedBundles.length === 0 && matchedAdhoc.length === 0 ? 'disabled' : ''}>
                <i class="fas fa-rocket"></i> Launch Execution
            </button>
        `;

        document.getElementById('audit-modal').classList.add('open');
    }

    function closeModal() {
        document.getElementById('audit-modal').classList.remove('open');
    }

    async function runAudit(clusterId, clusterName) {
        document.getElementById('modal-title').innerText = `Auditing: ${clusterName}`;
        const body = document.getElementById('modal-body');
        const footer = document.getElementById('audit-modal-footer');

        body.innerHTML = '<div style="text-align:center; padding:3rem;"><i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>Scanning cluster resources...</div>';
        footer.innerHTML = '<button class="btn btn-secondary" disabled>Executing Scan...</button>';

        try {
            const res = await fetch(`/api/audit/run?cluster_id=${clusterId}`, { method: 'POST' });
            const results = await res.json();

            if (results.length === 0) {
                body.innerHTML = '<div style="text-align:center; padding:2rem; opacity:0.7;">No rules matched or passed selection for this cluster.</div>';
                return;
            }

            // Group by Bundle
            const map = {};
            results.forEach(r => {
                const bName = r.bundle_name || 'Ad-hoc Rules';
                if (!map[bName]) map[bName] = [];
                map[bName].push(r);
            });

            let html = '';
            // Overall Stats
            const totalRules = results.length;
            const totalPass = results.filter(r => r.status === 'PASS').length;
            const score = Math.round((totalPass / totalRules) * 100);

            html += `
            <div style="margin-bottom:1.5rem; text-align:center; background:var(--bg-primary); padding:1rem; border-radius:8px;">
                <div style="font-size:0.9rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-secondary);">Overall Compliance Score</div>
                <div style="font-size:2.5rem; font-weight:bold; color:${score === 100 ? 'var(--success-color)' : (score >= 80 ? 'var(--warning-color)' : 'var(--danger-color)')};">
                    ${score}%
                </div>
                <div style="font-size:0.9rem; opacity:0.8;">${totalPass} / ${totalRules} Checks Passed</div>
            </div>
            `;

            for (const [bundleName, items] of Object.entries(map)) {
                const passed = items.filter(i => i.status === 'PASS').length;
                const total = items.length;
                const percent = Math.round((passed / total) * 100);
                const color = percent === 100 ? 'var(--success-color)' : (percent >= 80 ? 'var(--warning-color)' : 'var(--danger-color)');

                html += `
                <div style="margin-bottom:1rem; border:1px solid var(--border-color); border-radius:6px; overflow:hidden;">
                    <div style="background:rgba(255,255,255,0.03); padding:0.8rem; display:flex; justify-content:space-between; align-items:center;">
                        <strong style="font-size:1rem;">${bundleName}</strong>
                        <span class="badge" style="background:${color}20; color:${color}; border:1px solid ${color};">${passed}/${total} Passed</span>
                    </div>
                    <table class="data-table" style="margin:0;">
                        ${items.map(i => `
                            <tr>
                                <td style="padding:0.6rem 1rem;">
                                    <div style="font-weight:500;">${i.rule_name}</div>
                                    <div style="font-size:0.8rem; opacity:0.6;">${i.resource_kind} / ${i.namespace || '*'}</div>
                                    ${i.status !== 'PASS' ? `<div style="margin-top:0.3rem; font-size:0.85rem; color:var(--danger-color); background:rgba(239,68,68,0.1); padding:0.3rem; border-radius:4px;">${i.detail}</div>` : ''}
                                    ${i.failed_resources && i.failed_resources.length > 0 ? `
                                        <button class="btn btn-secondary btn-sm" style="margin-top:0.5rem; font-size:0.7rem; padding:0.2rem 0.5rem;" 
                                                onclick='viewSnapshots("${i.rule_name}", ${JSON.stringify(i.failed_resources).replace(/'/g, "&apos;")})'>
                                            <i class="fas fa-eye"></i> View Failure Snapshot
                                        </button>
                                    ` : ''}
                                </td>
                                <td style="width:80px; text-align:right; vertical-align:top;">
                                    <span class="badge ${i.status === 'PASS' ? 'badge-green' : 'badge-red'}">${i.status}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
                `;
            }
            body.innerHTML = html;
            footer.innerHTML = '<button class="btn btn-secondary" onclick="closeModal()">Close</button>';

            // Refresh dashboard scores
            loadData();

        } catch (e) {
            body.innerHTML = `<div style="color:var(--danger-color); text-align:center; padding:2rem;">
                <i class="fas fa-exclamation-triangle fa-2x"></i><br><br>
                Error executing audit: ${e.message}
            </div>`;
        }
    }

    // --- Mass Audit Logic ---
    let selectedMassMode = 'traits';
    let targetedClusters = [];

    function openMassAuditModal() {
        showMassStep(1);
        setMassMode('custom');
        // Populate bundle dropdown
        const bundleSelect = document.getElementById('mass-bundle-id');
        bundleSelect.innerHTML = ruleBundles.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        document.getElementById('mass-audit-modal').classList.add('open');
    }

    function closeMassAuditModal() {
        document.getElementById('mass-audit-modal').classList.remove('open');
    }

    function setMassMode(mode) {
        selectedMassMode = mode;
        document.getElementById('mode-custom').className = 'filter-card' + (mode === 'custom' ? ' active' : '');
        document.getElementById('mode-all').className = 'filter-card' + (mode === 'all' ? ' active' : '');
        document.getElementById('custom-filter').style.display = mode === 'custom' ? 'block' : 'none';
        document.getElementById('bundle-filter').style.display = mode === 'bundle' ? 'block' : 'none'; // Bundle filter no longer used directly but keeping for safety if needed

        const nextBtn = document.getElementById('mass-next-btn');
        const launchBtn = document.getElementById('mass-launch-btn');

        if (mode === 'all') {
            nextBtn.style.display = 'none';
            launchBtn.style.display = 'inline-block';
        } else {
            nextBtn.style.display = 'inline-block';
            launchBtn.style.display = 'none';
        }

        if (mode === 'custom') {
            renderCustomSelectionList();
        }
    }

    function renderCustomSelectionList() {
        const container = document.getElementById('custom-selection-list');
        let html = '';

        // Bundles
        ruleBundles.forEach(b => {
            html += `
                <div style="padding:0.5rem; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:0.8rem;">
                    <input type="checkbox" class="mass-custom-bundle-cb" value="${b.id}" id="cb-bundle-${b.id}">
                    <label for="cb-bundle-${b.id}" style="cursor:pointer; display:flex; flex-direction:column;">
                        <span style="font-weight:600; color:var(--accent-color);"><i class="fas fa-box"></i> ${b.name}</span>
                        <span style="font-size:0.75rem; opacity:0.6;">Bundle (Includes all child rules)</span>
                    </label>
                </div>
            `;
        });

        // Ad-hoc Rules
        const adhoc = adhocRules.filter(r => !r.bundle_id);
        adhoc.forEach(r => {
            html += `
                <div style="padding:0.5rem; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; align-items:center; gap:0.8rem;">
                    <input type="checkbox" class="mass-custom-rule-cb" value="${r.id}" id="cb-rule-${r.id}">
                    <label for="cb-rule-${r.id}" style="cursor:pointer; display:flex; flex-direction:column;">
                        <span style="font-weight:600;">${r.name}</span>
                        <span style="font-size:0.75rem; opacity:0.6;">Ad-hoc Rule</span>
                    </label>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function selectAllCustom(val) {
        document.querySelectorAll('.mass-custom-bundle-cb, .mass-custom-rule-cb').forEach(cb => cb.checked = val);
    }

    function showMassStep(step) {
        document.querySelectorAll('.mass-step').forEach(s => s.style.display = 'none');
        document.getElementById(`mass-step-${step}`).style.display = 'block';
    }

    async function calculateMassTargets() {
        if (selectedMassMode === 'custom') {
            const selectedBundles = Array.from(document.querySelectorAll('.mass-custom-bundle-cb:checked')).map(cb => parseInt(cb.value));
            const selectedRules = Array.from(document.querySelectorAll('.mass-custom-rule-cb:checked')).map(cb => parseInt(cb.value));

            if (selectedBundles.length === 0 && selectedRules.length === 0) {
                alert('Please select at least one bundle or rule.');
                return;
            }
            // In custom mode, targeted clusters are ALL clusters unless the user deselects them in preview
            targetedClusters = allClusters;
        } else if (selectedMassMode === 'all') {
            targetedClusters = allClusters;
            renderMassPreview(); // Populate checkboxes for launchMassAudit
            launchMassAudit();
            return;
        } else {
            const payload = {
                bundle_id: parseInt(document.getElementById('mass-bundle-id').value)
            };

            const res = await fetch('/api/audit/calculate-targets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            targetedClusters = await res.json();
        }

        renderMassPreview();
        showMassStep(2);
    }

    function renderMassPreview() {
        const summary = document.getElementById('target-summary');
        const list = document.getElementById('target-list');

        summary.innerHTML = `<i class="fas fa-bullseye"></i> ${targetedClusters.length} Clusters Targeted`;

        if (targetedClusters.length === 0) {
            list.innerHTML = '<div style="padding:2rem; text-align:center; opacity:0.5;">No clusters matched these criteria.</div>';
            return;
        }

        list.innerHTML = targetedClusters.map(c => `
            <div class="target-item">
                <input type="checkbox" checked value="${c.id}" class="cluster-target-cb">
                <div style="font-weight:500;">${c.name}</div>
            </div>
        `).join('');
    }

    async function launchMassAudit() {
        const selectedIds = Array.from(document.querySelectorAll('.cluster-target-cb:checked')).map(cb => parseInt(cb.value));
        if (selectedIds.length === 0) {
            alert('Please select at least one cluster.');
            return;
        }

        showMassStep(3);
        const progressFill = document.getElementById('mass-progress-fill');
        const progressText = document.getElementById('mass-progress-text');
        const log = document.getElementById('mass-log');
        log.innerHTML = '';

        const selectedBundleIds = Array.from(document.querySelectorAll('.mass-custom-bundle-cb:checked')).map(cb => parseInt(cb.value));
        const selectedRuleIds = Array.from(document.querySelectorAll('.mass-custom-rule-cb:checked')).map(cb => parseInt(cb.value));

        for (let i = 0; i < selectedIds.length; i++) {
            const id = selectedIds[i];
            const cluster = targetedClusters.find(c => c.id === id);
            const percent = Math.round(((i) / selectedIds.length) * 100);

            progressText.innerText = `Auditing ${cluster.name} (${i + 1} of ${selectedIds.length})...`;
            progressFill.style.width = `${percent}%`;

            log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] Starting audit on ${cluster.name}...</div>`;
            log.scrollTop = log.scrollHeight;

            try {
                const payload = {};
                if (selectedMassMode === 'custom') {
                    payload.bundle_ids = selectedBundleIds;
                    payload.rule_ids = selectedRuleIds;
                } else if (selectedMassMode === 'bundle') {
                    // Fallback for previous single-bundle mode if needed
                    const bId = document.getElementById('mass-bundle-id').value;
                    if (bId) payload.bundle_ids = [parseInt(bId)];
                }
                // If mode is 'all', payload stays empty to trigger all matching bundles

                await fetch(`/api/audit/run?cluster_id=${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Refresh data to show updated scores in background
                loadData();
                log.innerHTML += `<div style="color:var(--success-color);">[OK] Finished ${cluster.name}</div>`;
            } catch (e) {
                log.innerHTML += `<div style="color:var(--danger-color);">[ERROR] ${cluster.name}: ${e.message}</div>`;
            }
        }

        progressFill.style.width = '100%';
        progressText.innerText = 'Mass Audit Complete';
        log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] DONE. All targeted audits finished.</div>`;
        document.getElementById('mass-done').style.display = 'block';
    }

    loadData();
    function closeSnapshotModal() {
        document.getElementById('snapshot-modal').classList.remove('open');
    }

    function viewSnapshots(ruleName, data) {
        let resources = [];
        if (typeof data === 'string') {
            resources = window[data] || [];
        } else {
            resources = data;
        }

        document.getElementById('snapshot-title').innerText = `Failure Snapshots (YAML): ${ruleName}`;
        const content = document.getElementById('snapshot-content');

        if (!resources || resources.length === 0) {
            content.innerText = "No snapshot data available.";
        } else {
            let yamlText = "";
            resources.forEach((res, idx) => {
                yamlText += `# --- Snapshot ${idx + 1}: ${res.metadata?.name || 'Unnamed'} ---\n`;
                try {
                    // Use js-yaml for clean YAML output
                    yamlText += jsyaml.dump(res, { indent: 2, lineWidth: -1 }) + "\n\n";
                } catch (e) {
                    yamlText += "Error rendering YAML: " + e.message + "\n";
                    yamlText += JSON.stringify(res, null, 2) + "\n\n";
                }
            });
            content.innerText = yamlText;
        }

        document.getElementById('snapshot-modal').classList.add('open');
    }
</script>
{% endblock %}