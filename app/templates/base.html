<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCP Inventory</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- Optional for icons, using text fallback if not loading -->
    <!-- Using local simple icons or just text if fontawesome setup is complex without key. I'll use simple ASCII or text/emoji fallback if needed, or link a CDN that works -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="/dashboard" style="color:inherit; text-decoration:none;"><i class="fas fa-cubes"></i> OCP
                    Inventory</a>
            </div>


            <ul class="nav-links" id="cluster-list">
                <!-- User Profile Section -->
                {% if user %}
                <li
                    style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 0.3rem; display: flex; align-items: center; gap: 0.5rem;">
                    <div
                        style="width: 28px; height: 28px; background: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 0.8rem;">
                        {{ user.username[0]|upper }}
                    </div>
                    <div style="flex: 1; overflow: hidden;">
                        <div
                            style="font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ user.username }}</div>
                        <div style="font-size: 0.65rem; opacity: 0.6; display: flex; align-items: center; gap: 0.3rem;">
                            <i class="fas fa-circle" style="font-size: 0.35rem; color: var(--success-color);"></i>
                            {% if user.is_admin %}Administrator{% else %}Regular User{% endif %}
                        </div>
                    </div>
                    <a href="/logout" title="Logout"
                        style="color: var(--text-secondary); opacity: 0.6; transition: 0.2s;"
                        onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6">
                        <i class="fas fa-power-off"></i>
                    </a>
                </li>
                {% endif %}

                <!-- Snapshot Selector -->
                {% if user.is_admin %}
                <li
                    style="padding: 0.5rem 0.6rem; border-bottom: 1px solid var(--border-color); margin-bottom: 0.5rem;">
                    <div
                        style="font-size: 0.75rem; font-weight: bold; color: var(--text-secondary); margin-bottom: 0.3rem; display:flex; justify-content:space-between; align-items:center;">
                        SNAPSHOT <i class="fas fa-history"></i>
                    </div>
                    <select id="snapshot-selector" class="form-input"
                        style="font-size:0.75rem; padding:0.2rem; margin-bottom:0.3rem; width:100%; color:var(--text-primary); background:var(--bg-secondary); border:1px solid var(--border-color);"
                        onchange="toggleTimeTravel(this.value)">
                        <option value="">Live Mode (Real-time)</option>
                        <!-- Populated by JS -->
                    </select>
                    <div id="time-travel-indicator"
                        style="display:none; color:var(--warning-color); font-size:0.75rem; text-align:center; background:rgba(234, 179, 8, 0.1); padding:0.2rem; border-radius:4px; margin-top:0.2rem;">
                        <i class="fas fa-exclamation-triangle"></i> Historical View
                    </div>
                </li>
                {% endif %}

                <!-- Administration Group -->
                {% if user.is_admin %}
                <li
                    style="padding: 0.4rem 0.6rem; font-size: 0.7rem; font-weight: bold; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-top: 0.4rem; margin-bottom:0.1rem;">
                    Administration
                </li>
                <li class="nav-item">
                    <a href="/admin?tab=clusters"
                        class="nav-link {% if page == 'admin' and active_tab == 'clusters' %}active{% endif %}">
                        <i class="fas fa-server"></i> Clusters
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#"
                        class="nav-link submenu-toggle {% if page == 'admin' and active_tab in ['schedulers', 'snapshots'] %}active{% endif %}"
                        data-target="submenu-snapshots"
                        onclick="event.preventDefault(); toggleSubmenu('submenu-snapshots', this)">
                        <i class="fas fa-camera"></i> Snapshots
                        <i class="fas fa-chevron-down arrow"></i>
                    </a>
                    <div class="resource-submenu {% if page == 'admin' and active_tab in ['schedulers', 'snapshots'] %}open{% endif %}"
                        id="submenu-snapshots">
                        <a href="/admin?tab=schedulers"
                            class="sub-link {% if page == 'admin' and active_tab == 'schedulers' %}active{% endif %}">
                            <i class="fas fa-clock" style="width:16px;"></i> Scheduler
                        </a>
                        <a href="/admin?tab=snapshots"
                            class="sub-link {% if page == 'admin' and active_tab == 'snapshots' %}active{% endif %}">
                            <i class="fas fa-history" style="width:16px;"></i> Snapshots
                        </a>
                        <a href="/settings/db-stats"
                            class="sub-link {% if page == 'settings_db_stats' %}active{% endif %}">
                            <i class="fas fa-database" style="width:16px;"></i> DB Stats
                        </a>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#"
                        class="nav-link submenu-toggle {% if page in ['audit_rules', 'compliance'] %}active{% endif %}"
                        data-target="submenu-compliance"
                        onclick="event.preventDefault(); toggleSubmenu('submenu-compliance', this)">
                        <i class="fas fa-shield-alt"></i> Compliance
                        <i class="fas fa-chevron-down arrow"></i>
                    </a>
                    <div class="resource-submenu {% if page in ['audit_rules', 'compliance'] %}open{% endif %}"
                        id="submenu-compliance">
                        <a href="/audit" class="sub-link {% if page == 'audit_rules' %}active{% endif %}">
                            <i class="fas fa-clipboard-list" style="width:16px;"></i> Compliance Rules
                        </a>
                        <a href="/compliance" class="sub-link {% if page == 'compliance' %}active{% endif %}">
                            <i class="fas fa-check-circle" style="width:16px;"></i> Run Compliance
                        </a>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#"
                        class="nav-link submenu-toggle {% if page and page.startswith('settings_') %}active{% endif %}"
                        data-target="submenu-app-config"
                        onclick="event.preventDefault(); toggleSubmenu('submenu-app-config', this)">
                        <i class="fas fa-cog"></i> App Config
                        <i class="fas fa-chevron-down arrow"></i>
                    </a>
                    <div class="resource-submenu {% if page and page.startswith('settings_') %}open{% endif %}"
                        id="submenu-app-config">
                        <a href="/settings/users" class="sub-link {% if page == 'settings_users' %}active{% endif %}">
                            <i class="fas fa-users" style="width:16px;"></i> Users
                        </a>
                        <a href="/settings/ldap" class="sub-link {% if page == 'settings_ldap' %}active{% endif %}">
                            <i class="fas fa-network-wired" style="width:16px;"></i> LDAP Settings
                        </a>
                        <a href="/settings/license"
                            class="sub-link {% if page == 'settings_license' %}active{% endif %}">
                            <i class="fas fa-file-invoice-dollar" style="width:16px;"></i> Cluster License Config
                        </a>
                    </div>
                </li>
                {% endif %}

                <li class="nav-item"
                    style="margin-top: 0.5rem; border-top: 1px solid var(--border-color); padding: 0.25rem 0 0 0;">
                    <a href="/dashboard" class="nav-link {% if page == 'dashboard' %}active{% endif %}">
                        <i class="fas fa-th-large"></i> All Clusters
                    </a>
                </li>
                {% if user.is_admin %}
                <li class="nav-item"
                    style="padding: 0 0 0.25rem 0; border-bottom: 1px solid var(--border-color); margin-bottom: 0.25rem;">
                    <a href="/analytics" class="nav-link {% if page == 'analytics' %}active{% endif %}">
                        <i class="fas fa-chart-line"></i> Analytics (Trend)
                    </a>
                </li>
                {% else %}
                <li style="border-bottom: 1px solid var(--border-color); margin-bottom: 0.25rem;"></li>
                {% endif %}

                <li style="padding: 0.4rem 0.6rem; margin-bottom: 0.3rem;">
                    <input type="text" id="cluster-search" placeholder="Search clusters..." class="form-input"
                        style="font-size:0.8rem; padding:0.35rem; margin-bottom: 0.4rem; width:100%; box-sizing:border-box;"
                        onkeyup="filterClusters()">

                    <div style="display: flex; gap: 0.25rem; flex-wrap: wrap; margin-bottom: 0.25rem;">
                        <button class="filter-btn" onclick="toggleFilter(this, 'DEV')" data-filter="DEV"
                            style="flex:1; font-size:0.7rem; padding:0.25rem;">DEV</button>
                        <button class="filter-btn" onclick="toggleFilter(this, 'UAT')" data-filter="UAT"
                            style="flex:1; font-size:0.7rem; padding:0.25rem;">UAT</button>
                        <button class="filter-btn" onclick="toggleFilter(this, 'PROD')" data-filter="PROD"
                            style="flex:1; font-size:0.7rem; padding:0.25rem;">PROD</button>
                    </div>
                    <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                        <button class="filter-btn" onclick="toggleFilter(this, 'AZURE')" data-filter="AZURE"
                            style="flex:1; font-size:0.7rem; padding:0.25rem;">AZURE</button>
                        <button class="filter-btn" onclick="toggleFilter(this, 'HCI')" data-filter="HCI"
                            style="flex:1; font-size:0.7rem; padding:0.25rem;">HCI</button>
                    </div>
                </li>

                {% if clusters_by_dc %}
                {% for dc, dc_clusters in clusters_by_dc.items() %}
                <li
                    style="padding: 0.3rem 0.6rem; font-size: 0.7rem; font-weight: bold; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-top: 0.75rem;">
                    {{ dc }}
                </li>

                {% for cluster in dc_clusters %}
                <li class="nav-item cluster-item" data-name="{{ cluster.name|lower }}"
                    data-dc="{{ cluster.datacenter }}" data-env="{{ cluster.environment }}">
                    <a href="#" class="nav-link cluster-link" data-cluster-id="{{ cluster.id }}"
                        onclick="toggleClusterMenu({{ cluster.id }})">
                        <i class="fas fa-server"></i> {{ cluster.name }}
                        <span style="font-size:0.7rem; opacity:0.7; margin-left: auto;">{{ cluster.environment }}</span>
                    </a>
                    <div class="resource-submenu" id="submenu-{{ cluster.id }}">
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'nodes', '{{ cluster.name }}')">Nodes</a>
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'machines', '{{ cluster.name }}')">Machines</a>
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'machinesets', '{{ cluster.name }}')">MachineSets</a>
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'projects', '{{ cluster.name }}')">Projects</a>
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'machineautoscalers', '{{ cluster.name }}')">Autoscalers</a>
                    </div>
                </li>
                {% endfor %}

                {% endfor %}
                {% else %}
                <!-- Legacy fallback if viewed directly without dict, though router handles it -->
                {% for cluster in clusters %}
                <li class="nav-item cluster-item" data-name="{{ cluster.name|lower }}"
                    data-dc="{{ cluster.datacenter }}" data-env="{{ cluster.environment }}">
                    <a href="#" class="nav-link cluster-link" data-cluster-id="{{ cluster.id }}"
                        onclick="toggleClusterMenu({{ cluster.id }})">
                        <i class="fas fa-server"></i> {{ cluster.name }}
                        <span style="font-size:0.7rem; opacity:0.7; margin-left: auto;">{{ cluster.environment }}</span>
                    </a>
                    <div class="resource-submenu" id="submenu-{{ cluster.id }}">
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'nodes', '{{ cluster.name }}')">Nodes</a>
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'machines', '{{ cluster.name }}')">Machines</a>
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'machinesets', '{{ cluster.name }}')">MachineSets</a>
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'projects', '{{ cluster.name }}')">Projects</a>
                        <a href="#" class="sub-link"
                            onclick="loadResource({{ cluster.id }}, 'machineautoscalers', '{{ cluster.name }}')">Autoscalers</a>
                    </div>
                </li>
                {% endfor %}
                {% endif %}
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>

    <script src="/static/app.js"></script>
</body>

</html>