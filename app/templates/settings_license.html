{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">License Configuration</h1>
    <div style="display:flex; align-items:center; gap:1rem;">
        <button class="btn btn-primary" onclick="openAddRuleModal()">
            <i class="fas fa-plus"></i> Add Rule
        </button>
        <button class="btn btn-secondary" onclick="previewRules()">
            <i class="fas fa-play"></i> Preview Rules
        </button>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Rules Table -->
    <div class="card">
        <h3 style="margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border-color);">Node
            Selection Rules</h3>
        {% if rules %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Rule Name</th>
                    <th>Type</th>
                    <th>Match Pattern</th>
                    <th>Action</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for rule in rules %}
                <tr>
                    <td>{{ rule.name }}</td>
                    <td>
                        {% if rule.rule_type == 'name_match' %}Node Name (Regex){% else %}Node Label{% endif %}
                    </td>
                    <td><code>{{ rule.match_value }}</code></td>
                    <td>
                        {% if rule.action == 'INCLUDE' %}
                        <span class="badge badge-green">INCLUDE</span>
                        {% else %}
                        <span class="badge badge-red">EXCLUDE</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="openEditRuleModal({{ rule.id }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRule({{ rule.id }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="padding:2rem; text-align:center; opacity:0.6;">
            No rules defined. Default behavior: <strong>Ignore All</strong> (unless included).
        </div>
        {% endif %}
    </div>

    <!-- Preview Panel -->
    <div class="card">
        <h3 style="margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border-color);">Preview</h3>
        <div style="margin-bottom:1rem;">
            <label style="display:block; margin-bottom:0.5rem; font-size:0.85rem;">Select Cluster to Test</label>
            <select id="preview-cluster" class="form-input">
                {% for cluster in clusters %}
                <option value="{{ cluster.id }}">{{ cluster.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="preview-results" style="display:none; background:rgba(0,0,0,0.2); padding:1rem; border-radius:4px;">
            <!-- Results injected here -->
        </div>
    </div>
</div>

<!-- Rule Modal -->
<div id="rule-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modal-title">Add Selection Rule</h3>
            <span class="close-btn" onclick="closeRuleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="rule-id">
            <div class="form-group">
                <label>Rule Name</label>
                <input type="text" id="rule-name" class="form-input" placeholder="e.g. Include Workers">
            </div>
            <div class="form-group">
                <label>Action</label>
                <select id="rule-action" class="form-input">
                    <option value="INCLUDE">INCLUDE</option>
                    <option value="EXCLUDE">EXCLUDE</option>
                </select>
            </div>
            <div class="form-group">
                <label>Match Type</label>
                <select id="rule-type" class="form-input">
                    <option value="label_match">Node Label (key=value)</option>
                    <option value="name_match">Node Name (Regex)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Match Pattern</label>
                <input type="text" id="rule-value" class="form-input"
                    placeholder="e.g. node-role.kubernetes.io/worker=">
                <small style="display:block; margin-top:0.3rem; opacity:0.6;">For labels, use 'key=value' or just 'key'
                    to check existence.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeRuleModal()">Cancel</button>
            <button class="btn btn-primary" id="modal-submit-btn" onclick="submitRule()">Create Rule</button>
        </div>
    </div>
</div>

<script>
    function openAddRuleModal() {
        document.getElementById('modal-title').innerText = 'Add Selection Rule';
        document.getElementById('modal-submit-btn').innerText = 'Create Rule';
        document.getElementById('rule-id').value = '';
        document.getElementById('rule-name').value = '';
        document.getElementById('rule-action').value = 'INCLUDE';
        document.getElementById('rule-type').value = 'label_match';
        document.getElementById('rule-value').value = '';
        document.getElementById('rule-modal').classList.add('open');
    }

    // Global rules storage to avoid escaping issues in attributes
    const rules = [
        {% for rule in rules %}
    {{ rule.dict() | tojson | safe }} {% if not loop.last %}, {% endif %}
    {% endfor %}
    ];

    function openEditRuleModal(ruleId) {
        const rule = rules.find(r => r.id === ruleId);
        if (!rule) return;

        document.getElementById('modal-title').innerText = 'Edit Selection Rule';
        document.getElementById('modal-submit-btn').innerText = 'Update Rule';
        document.getElementById('rule-id').value = rule.id;
        document.getElementById('rule-name').value = rule.name;
        document.getElementById('rule-action').value = rule.action;
        document.getElementById('rule-type').value = rule.rule_type;
        document.getElementById('rule-value').value = rule.match_value;
        document.getElementById('rule-modal').classList.add('open');
    }

    function closeRuleModal() {
        document.getElementById('rule-modal').classList.remove('open');
    }

    async function submitRule() {
        const id = document.getElementById('rule-id').value;
        const name = document.getElementById('rule-name').value;
        const action = document.getElementById('rule-action').value;
        const type = document.getElementById('rule-type').value;
        const value = document.getElementById('rule-value').value;

        if (!name || !value) {
            alert("Please fill in all fields");
            return;
        }

        const url = id ? `/settings/api/license/rules/${id}` : '/settings/api/license/rules';
        const method = id ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    action: action,
                    rule_type: type,
                    match_value: value
                })
            });

            if (res.ok) {
                window.location.reload();
            } else {
                alert("Failed to save rule");
            }
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    async function deleteRule(id) {
        if (!confirm("Are you sure you want to delete this rule?")) return;

        try {
            const res = await fetch(`/settings/api/license/rules/${id}`, {
                method: 'DELETE'
            });
            if (res.ok) window.location.reload();
        } catch (e) {
            alert(e.message);
        }
    }

    async function previewRules() {
        const clusterId = document.getElementById('preview-cluster').value;
        const resultDiv = document.getElementById('preview-results');

        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="text-align:center;"><i class="fas fa-spin fa-circle-notch"></i> Calculating...</div>';

        try {
            // We are previewing SAVED rules only for now as requested by user logic flow
            // The implementation plan suggested previewing temp rules, but for UI simplicity let's verify DB state first.
            // Or we could pass current DB state + any unsaved? But we don't have unsaved state in table.
            // So just preview DB rules against cluster.

            const res = await fetch('/settings/api/license/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cluster_id: parseInt(clusterId),
                    temp_rules: null // Use DB rules
                })
            });

            const data = await res.json();

            if (!data.ok) {
                resultDiv.innerHTML = `<div style="color:red">Error: ${data.error}</div>`;
                return;
            }

            const r = data.result;

            resultDiv.innerHTML = `
            <div style="margin-bottom:1rem; font-weight:bold;">
                Matched Nodes: ${r.node_count} <br>
                Licenses Required: <span style="color:var(--accent-color); font-size:1.2rem;">${r.total_licenses}</span>
            </div>
            <div style="max-height:300px; overflow-y:auto; font-size:0.85rem;">
                <table class="data-table" style="width:100%;">
                    <thead><tr><th>Node</th><th>Status</th><th>vCPU</th></tr></thead>
                    <tbody>
                    ${r.details.map(d => `
                        <tr style="opacity:${d.status === 'INCLUDED' ? 1 : 0.5}">
                            <td>${d.name}</td>
                            <td>${d.status}</td>
                            <td>${d.vcpu}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        } catch (e) {
            resultDiv.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
        }
    }
</script>
{% endblock %}
