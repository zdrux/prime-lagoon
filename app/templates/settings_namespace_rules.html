{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Namespace Exclusion Rules</h1>
    <div style="display:flex; align-items:center; gap:1rem;">
        <button class="btn btn-primary" onclick="openAddRuleModal()">
            <i class="fas fa-plus"></i> Add Exclusion Rule
        </button>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid var(--border-color);">Defined Rules
    </h3>
    <p style="opacity:0.7; margin-bottom:1.5rem;">These rules define namespaces that should be <strong>ignored</strong>
        when reporting unmapped projects.</p>

    {% if rules %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Rule Name</th>
                <th>Pattern (Regex)</th>
                <th>Action</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in rules %}
            <tr>
                <td>{{ rule.name }}</td>
                <td><code>{{ rule.match_pattern }}</code></td>
                <td><span class="badge badge-red">EXCLUDE</span></td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="openEditRuleModal({{ rule.id }})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteRule({{ rule.id }})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding:2rem; text-align:center; opacity:0.6; background:rgba(0,0,0,0.02); border-radius:8px;">
        No exclusion rules defined. All namespaces without a MAPID will be reported.
    </div>
    {% endif %}
</div>

<!-- Rule Modal -->
<div id="rule-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="modal-title">Add Exclusion Rule</h3>
            <span class="close-btn" onclick="closeRuleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <input type="hidden" id="rule-id">
            <div class="form-group">
                <label>Rule Name</label>
                <input type="text" id="rule-name" class="form-input" placeholder="e.g. Ignore OpenShift System">
            </div>
            <div class="form-group">
                <label>Regex Pattern</label>
                <input type="text" id="rule-pattern" class="form-input" placeholder="e.g. ^openshift-.*">
                <small style="display:block; margin-top:0.3rem; opacity:0.6;">Namespaces matching this request will be
                    excluded.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeRuleModal()">Cancel</button>
            <button class="btn btn-primary" id="modal-submit-btn" onclick="submitRule()">Create Rule</button>
        </div>
    </div>
</div>

<script>
    const rules = [
        {% for rule in rules %}
    {
        "id": {{ rule.id | tojson }},
        "name": {{ rule.name | tojson }},
        "match_pattern": {{ rule.match_pattern | tojson }}
    } {% if not loop.last %}, {% endif %}
    {% endfor %}
    ];

    function openAddRuleModal() {
        document.getElementById('modal-title').innerText = 'Add Exclusion Rule';
        document.getElementById('modal-submit-btn').innerText = 'Create Rule';
        document.getElementById('rule-id').value = '';
        document.getElementById('rule-name').value = '';
        document.getElementById('rule-pattern').value = '';
        document.getElementById('rule-modal').classList.add('open');
    }

    function openEditRuleModal(id) {
        const rule = rules.find(r => r.id === id);
        if (!rule) return;

        document.getElementById('modal-title').innerText = 'Edit Exclusion Rule';
        document.getElementById('modal-submit-btn').innerText = 'Update Rule';
        document.getElementById('rule-id').value = rule.id;
        document.getElementById('rule-name').value = rule.name;
        document.getElementById('rule-pattern').value = rule.match_pattern;
        document.getElementById('rule-modal').classList.add('open');
    }

    function closeRuleModal() {
        document.getElementById('rule-modal').classList.remove('open');
    }

    async function submitRule() {
        const id = document.getElementById('rule-id').value;
        const name = document.getElementById('rule-name').value;
        const pattern = document.getElementById('rule-pattern').value;

        if (!name || !pattern) {
            alert("Please fill in all fields");
            return;
        }

        const url = id ? `/settings/api/namespaces/rules/${id}` : '/settings/api/namespaces/rules';
        const method = id ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    match_pattern: pattern
                })
            });

            if (res.ok) {
                window.location.reload();
            } else {
                alert("Failed to save rule");
            }
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    async function deleteRule(id) {
        if (!confirm("Are you sure you want to delete this rule?")) return;

        try {
            const res = await fetch(`/settings/api/namespaces/rules/${id}`, {
                method: 'DELETE'
            });
            if (res.ok) window.location.reload();
        } catch (e) {
            alert(e.message);
        }
    }
</script>
{% endblock %}